{% extends "base.html" %}

{% block title %}לוח זמנים חודשי - איזון עומסים{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-calendar3 me-2"></i>יומן ולוח זמנים</h2>
            <div class="d-flex align-items-center gap-3">
                <!-- View Type Selector -->
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewType" id="scheduleView" value="schedule" {% if not request.args.get('view') or request.args.get('view') == 'schedule' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="scheduleView">
                        <i class="bi bi-list-ul me-1"></i>לוח זמנים
                    </label>
                    
                    <input type="radio" class="btn-check" name="viewType" id="calendarYearView" value="calendar-year" {% if request.args.get('view') == 'calendar-year' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="calendarYearView">
                        <i class="bi bi-calendar-year me-1"></i>יומן שנתי
                    </label>
                    
                    <input type="radio" class="btn-check" name="viewType" id="calendarMonthView" value="calendar-month" {% if request.args.get('view') == 'calendar-month' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="calendarMonthView">
                        <i class="bi bi-calendar-month me-1"></i>יומן חודשי
                    </label>
                    
                    <input type="radio" class="btn-check" name="viewType" id="calendarWeekView" value="calendar-week" {% if request.args.get('view') == 'calendar-week' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="calendarWeekView">
                        <i class="bi bi-calendar-week me-1"></i>יומן שבועי
                    </label>
                </div>
                
                <!-- Year and Month Selectors (for schedule view) -->
                <div class="d-flex align-items-center gap-2" id="scheduleSelectors" {% if request.args.get('view') and request.args.get('view') != 'schedule' %}style="display: none !important;"{% endif %}>
                    <select id="yearSelect" class="form-select form-select-sm" style="width: auto;">
                        {% for y in range(2020, 2031) %}
                            <option value="{{ y }}" {% if y == (schedule.year if not is_yearly else year) %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                    <select id="monthSelect" class="form-select form-select-sm" style="width: auto;">
                        <option value="all" {% if request.args.get('month') == 'all' %}selected{% endif %}>כל השנה</option>
                        {% set months = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'] %}
                        {% for i in range(1, 13) %}
                            <option value="{{ i }}" {% if i == schedule.month and request.args.get('month') != 'all' %}selected{% endif %}>{{ months[i-1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="btn-group" id="scheduleNavigation" {% if request.args.get('view') and request.args.get('view') != 'schedule' %}style="display: none !important;"{% endif %}>
                    {% if is_yearly %}
                        <a href="{{ url_for('schedule', year=year-1, month='all') }}" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <button class="btn btn-primary disabled">
                            {{ year }}
                        </button>
                        <a href="{{ url_for('schedule', year=year+1, month='all') }}" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    {% else %}
                        <a href="{{ url_for('schedule', year=schedule.year if schedule.month > 1 else schedule.year-1, month=schedule.month-1 if schedule.month > 1 else 12) }}" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <button class="btn btn-primary disabled">
                            {{ schedule.month }}/{{ schedule.year }}
                        </button>
                        <a href="{{ url_for('schedule', year=schedule.year if schedule.month < 12 else schedule.year+1, month=schedule.month+1 if schedule.month < 12 else 1) }}" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    {% endif %}
                </div>
                
                <!-- Calendar Navigation (for calendar views) -->
                <div class="btn-group" id="calendarNavigation" {% if not request.args.get('view') or request.args.get('view') == 'schedule' %}style="display: none;"{% endif %}>
                    <button class="btn btn-outline-secondary" id="prevPeriod">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn btn-outline-secondary" id="nextPeriod">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-primary ms-2" id="todayBtn">היום</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Content Container -->
<div id="calendarContent" {% if not request.args.get('view') or request.args.get('view') == 'schedule' %}style="display: none;"{% endif %}>
    {% if view_type == 'calendar-year' %}
        {% include 'calendar_year.html' %}
    {% elif view_type == 'calendar-month' %}
        {% include 'calendar_month.html' %}
    {% elif view_type == 'calendar-week' %}
        {% include 'calendar_week.html' %}
    {% endif %}
</div>

<!-- Schedule Content Container -->
<div id="scheduleContent" {% if request.args.get('view') and request.args.get('view') != 'schedule' %}style="display: none;"{% endif %}>

<!-- Statistics -->
{% if is_yearly %}
<!-- Yearly Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="bi bi-calendar3 text-success" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">
                    {% set total_business_days = 0 %}
                    {% for month_num, month_schedule in schedule.items() %}
                        {% set total_business_days = total_business_days + (month_schedule.business_days|length) %}
                    {% endfor %}
                    {{ total_business_days }}
                </h5>
                <p class="card-text">ימי עסקים בשנה</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <i class="bi bi-calendar-x text-danger" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">
                    {% set total_exception_days = 0 %}
                    {% for month_num, month_schedule in schedule.items() %}
                        {% set total_exception_days = total_exception_days + (month_schedule.exception_dates|length) %}
                    {% endfor %}
                    {{ total_exception_days }}
                </h5>
                <p class="card-text">ימי חריג בשנה</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="bi bi-people text-info" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">
                    {% set unique_committees = [] %}
                    {% for month_num, month_schedule in schedule.items() %}
                        {% for committee_name in month_schedule.committees.keys() %}
                            {% if committee_name not in unique_committees %}
                                {% set _ = unique_committees.append(committee_name) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    {{ unique_committees|length }}
                </h5>
                <p class="card-text">סוגי וועדות</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <i class="bi bi-calendar-event text-warning" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">
                    {% set total_meetings = 0 %}
                    {% for month_num, month_schedule in schedule.items() %}
                        {% for committee_name, dates in month_schedule.committees.items() %}
                            {% set total_meetings = total_meetings + (dates|selectattr('can_schedule')|list|length) %}
                        {% endfor %}
                    {% endfor %}
                    {{ total_meetings }}
                </h5>
                <p class="card-text">ישיבות מתוזמנות בשנה</p>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Monthly Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="bi bi-calendar3 text-success" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">{{ schedule.business_days|length }}</h5>
                <p class="card-text">ימי עסקים</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <i class="bi bi-calendar-x text-danger" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">{{ schedule.exception_dates|length }}</h5>
                <p class="card-text">ימי חריג</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="bi bi-people text-info" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">{{ schedule.committees|length }}</h5>
                <p class="card-text">וועדות</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <i class="bi bi-calendar-event text-warning" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">
                    {% set total_meetings = 0 %}
                    {% for committee_name, dates in schedule.committees.items() %}
                        {% set total_meetings = total_meetings + (dates|selectattr('can_schedule')|list|length) %}
                    {% endfor %}
                    {{ total_meetings }}
                </h5>
                <p class="card-text">ישיבות מתוזמנות</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Committees Schedule -->
<div class="row">
    {% if is_yearly %}
        <!-- Yearly View - Show by months -->
        {% set months = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'] %}
        {% for month_num in range(1, 13) %}
            {% if month_num in schedule %}
                {% set month_schedule = schedule[month_num] %}
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0">
                                <i class="bi bi-calendar-month me-2"></i>{{ months[month_num-1] }} {{ year }}
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for committee_name, dates in month_schedule.committees.items() %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-secondary">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-people me-2"></i>{{ committee_name }}
                                            </h6>
                                        </div>
                                        <div class="card-body p-2">
                                            {% if dates %}
                                                <div class="list-group list-group-flush">
                                                    {% for date_info in dates %}
                                                    <div class="list-group-item d-flex justify-content-between align-items-center {% if date_info.can_schedule %}clickable-date{% endif %}"
                                                         {% if date_info.can_schedule %}
                                                         data-committee="{{ committee_name }}" 
                                                         data-date="{{ date_info.date.strftime('%Y-%m-%d') }}"
                                                         data-vaadot-id="{{ date_info.vaadot_id if date_info.vaadot_id else '' }}"
                                                         style="cursor: pointer;"
                                                         title="לחץ להוספת אירוע"
                                                         {% endif %}>
                                                        <div>
                                                            <strong>{{ date_info.date.strftime('%d/%m') }}</strong>
                                                            <small class="text-muted d-block">
                                                                {% set weekdays = ['יום ב\'', 'יום ג\'', 'יום ד\'', 'יום ה\'', 'יום ו\'', 'שבת', 'יום א\''] %}
                                                                {{ weekdays[date_info.date.weekday()] }}
                                                            </small>
                                                        </div>
                                                        <div>
                                                            {% if date_info.can_schedule %}
                                                                <span class="badge bg-success">
                                                                    <i class="bi bi-plus-circle me-1"></i>זמין
                                                                </span>
                                                            {% else %}
                                                                <span class="badge bg-danger" title="{{ date_info.reason }}">לא זמין</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <p class="text-muted text-center py-2 mb-0">אין תאריכים מתוזמנים</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <!-- Monthly View - Original layout -->
        {% for committee_name, dates in schedule.committees.items() %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>{{ committee_name }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if dates %}
                        <div class="list-group list-group-flush">
                            {% for date_info in dates %}
                            <div class="list-group-item d-flex justify-content-between align-items-center {% if date_info.can_schedule %}clickable-date{% endif %}"
                                 {% if date_info.can_schedule %}
                                 data-committee="{{ committee_name }}" 
                                 data-date="{{ date_info.date.strftime('%Y-%m-%d') }}"
                                 data-vaadot-id="{{ date_info.vaadot_id if date_info.vaadot_id else '' }}"
                                 style="cursor: pointer;"
                                 title="לחץ להוספת אירוע"
                                 {% endif %}>
                                <div>
                                    <strong>{{ date_info.date.strftime('%d/%m') }}</strong>
                                    <small class="text-muted d-block">
                                        {% set weekdays = ['יום ב\'', 'יום ג\'', 'יום ד\'', 'יום ה\'', 'יום ו\'', 'שבת', 'יום א\''] %}
                                        {{ weekdays[date_info.date.weekday()] }}
                                    </small>
                                </div>
                                <div>
                                    {% if date_info.can_schedule %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-plus-circle me-1"></i>זמין
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger" title="{{ date_info.reason }}">לא זמין</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-3">אין תאריכים מתוזמנים החודש</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Exception Dates -->
{% if not is_yearly and schedule.exception_dates %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-x me-2"></i>תאריכי חריגים החודש
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for exc_date in schedule.exception_dates %}
                    <div class="col-md-4 mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-calendar-x text-warning me-2"></i>
                            <span>{{ exc_date.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

</div> <!-- End Schedule Content Container -->

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>הוספת אירוע חדש
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_event') }}" id="scheduleEventForm">
                <div class="modal-body">
                    <!-- Selected Committee and Date Info -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>ועדה:</strong> <span id="selectedCommittee"></span><br>
                        <strong>תאריך:</strong> <span id="selectedDate"></span>
                    </div>

                    <!-- Hidden fields for committee and date -->
                    <input type="hidden" id="vaadot_id" name="vaadot_id">
                    
                    <!-- Route Selection -->
                    <div class="mb-3">
                        <label for="schedule_maslul_id" class="form-label">
                            <i class="bi bi-signpost me-2"></i>בחר מסלול <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="schedule_maslul_id" name="maslul_id" required>
                            <option value="">בחר מסלול</option>
                            {% for maslul in maslulim %}
                                <option value="{{ maslul.maslul_id }}" 
                                        data-hativa-id="{{ maslul.hativa_id }}"
                                        style="display: none;">
                                    {{ maslul.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">רק מסלולים מחטיבת הועדה יוצגו</div>
                    </div>

                    <hr>

                    <!-- Event Details -->
                    <div class="mb-3">
                        <label for="schedule_event_name" class="form-label">שם האירוע <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="schedule_event_name" name="name" required placeholder="הכנס שם האירוע">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedule_event_type" class="form-label">סוג האירוע <span class="text-danger">*</span></label>
                                <select class="form-select" id="schedule_event_type" name="event_type" required>
                                    <option value="">בחר סוג</option>
                                    <option value="kokok">קו"ק</option>
                                    <option value="shotef">שוטף</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedule_expected_requests" class="form-label">היקף בקשות צפוי</label>
                                <input type="number" class="form-control" id="schedule_expected_requests" name="expected_requests" min="0" value="0" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>צור אירוע
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const hativaSelect = document.getElementById('schedule_hativa_select');
    const maslulSelect = document.getElementById('schedule_maslul_id');
    
    // Handle date clicks using event delegation
    document.addEventListener('click', function(e) {
        if (e.target.closest('.clickable-date')) {
            const dateElement = e.target.closest('.clickable-date');
            const committee = dateElement.getAttribute('data-committee');
            const date = dateElement.getAttribute('data-date');
            const vaadotId = dateElement.getAttribute('data-vaadot-id');
            
            console.log('Clicked on date:', date, 'committee:', committee, 'vaadot_id:', vaadotId);
            
            // Set the committee meeting ID and display info
            document.getElementById('vaadot_id').value = vaadotId;
            document.getElementById('selectedCommittee').textContent = committee;
            document.getElementById('selectedDate').textContent = new Date(date).toLocaleDateString('he-IL');
            
            // Reset form
            document.getElementById('scheduleEventForm').reset();
            document.getElementById('vaadot_id').value = vaadotId; // Keep vaadot_id after reset
            
            // Find the committee's division and show only relevant routes
            filterRoutesByCommittee(vaadotId);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('addEventModal')).show();
        }
    });
    
    // Handle division selection
    hativaSelect.addEventListener('change', function() {
        const selectedHativaId = this.value;
        
        maslulSelect.value = '';
        
        if (!selectedHativaId) {
            maslulSelect.disabled = true;
            maslulSelect.innerHTML = '<option value="">תחילה בחר חטיבה</option>';
            return;
        }
        
        // Enable route selection and filter by division
        maslulSelect.disabled = false;
        maslulSelect.innerHTML = '<option value="">בחר מסלול</option>';
        
        // Show only routes from selected division
        const allRoutes = document.querySelectorAll('#schedule_maslul_id option[data-hativa-id]');
        allRoutes.forEach(option => {
            if (option.getAttribute('data-hativa-id') === selectedHativaId) {
                const newOption = option.cloneNode(true);
                newOption.style.display = 'block';
                maslulSelect.appendChild(newOption);
            }
        });
    });
    
    // Function to filter routes by committee's division
    function filterRoutesByCommittee(vaadotId) {
        console.log('Filtering routes for vaadot_id:', vaadotId);
        
        if (!vaadotId || vaadotId === '') {
            console.log('No vaadot_id provided, showing all routes');
            showAllRoutes();
            return;
        }
        
        // Make API call to get committee's division
        fetch(`/api/vaadot/${vaadotId}/hativa`)
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API response data:', data);
                if (data.success) {
                    const hativaId = data.hativa_id;
                    console.log('Committee hativa_id:', hativaId);
                    showRoutesForDivision(hativaId);
                } else {
                    console.error('Failed to get committee division:', data.error);
                    // Fallback: show all routes
                    showAllRoutes();
                }
            })
            .catch(error => {
                console.error('Error fetching committee division:', error);
                // Fallback: show all routes
                showAllRoutes();
            });
    }
    
    function showRoutesForDivision(hativaId) {
        console.log('Showing routes for hativa_id:', hativaId);
        
        // Reset route selection
        maslulSelect.innerHTML = '<option value="">בחר מסלול</option>';
        
        // Show only routes from the committee's division
        const allOptions = document.querySelectorAll('#schedule_maslul_id option[data-hativa-id]');
        console.log('Found', allOptions.length, 'route options');
        
        let matchingRoutes = 0;
        allOptions.forEach(option => {
            const optionHativaId = option.getAttribute('data-hativa-id');
            console.log('Option hativa_id:', optionHativaId, 'comparing with:', hativaId.toString());
            
            if (optionHativaId === hativaId.toString()) {
                const newOption = option.cloneNode(true);
                newOption.style.display = 'block';
                maslulSelect.appendChild(newOption);
                matchingRoutes++;
                console.log('Added route:', option.textContent);
            }
        });
        
        console.log('Total matching routes added:', matchingRoutes);
    }
    
    function showAllRoutes() {
        // Fallback: show all routes
        maslulSelect.innerHTML = '<option value="">בחר מסלול</option>';
        const allOptions = document.querySelectorAll('#schedule_maslul_id option[data-hativa-id]');
        allOptions.forEach(option => {
            const newOption = option.cloneNode(true);
            newOption.style.display = 'block';
            maslulSelect.appendChild(newOption);
        });
    }
    
    // Add hover effects
    document.querySelectorAll('.clickable-date').forEach(element => {
        element.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        element.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // Handle view type changes
    document.querySelectorAll('input[name="viewType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const viewType = this.value;
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                
                // Show/hide appropriate controls
                const scheduleSelectors = document.getElementById('scheduleSelectors');
                const scheduleNavigation = document.getElementById('scheduleNavigation');
                const calendarNavigation = document.getElementById('calendarNavigation');
                const scheduleContent = document.getElementById('scheduleContent');
                const calendarContent = document.getElementById('calendarContent');
                
                if (viewType === 'schedule') {
                    // Show schedule view
                    scheduleSelectors.style.display = 'flex';
                    scheduleNavigation.style.display = 'flex';
                    calendarNavigation.style.display = 'none';
                    scheduleContent.style.display = 'block';
                    calendarContent.style.display = 'none';
                    
                    // Navigate to schedule view
                    window.location.href = `{{ url_for('schedule') }}?view=schedule&year=${year}&month=${month}`;
                } else {
                    // Show calendar view
                    scheduleSelectors.style.display = 'none';
                    scheduleNavigation.style.display = 'none';
                    calendarNavigation.style.display = 'flex';
                    scheduleContent.style.display = 'none';
                    calendarContent.style.display = 'block';
                    
                    // Navigate to calendar view
                    window.location.href = `{{ url_for('schedule') }}?view=${viewType}&year=${year}`;
                }
            }
        });
    });

    // Handle year and month selection changes
    document.getElementById('yearSelect').addEventListener('change', function() {
        const year = this.value;
        const month = document.getElementById('monthSelect').value;
        const view = document.querySelector('input[name="viewType"]:checked').value;
        if (view === 'schedule') {
            window.location.href = `{{ url_for('schedule') }}?view=schedule&year=${year}&month=${month}`;
        } else {
            window.location.href = `{{ url_for('schedule') }}?view=${view}&year=${year}`;
        }
    });
    
    document.getElementById('monthSelect').addEventListener('change', function() {
        const month = this.value;
        const year = document.getElementById('yearSelect').value;
        const view = document.querySelector('input[name="viewType"]:checked').value;
        if (view === 'schedule') {
            if (month === 'all') {
                window.location.href = `{{ url_for('schedule') }}?view=schedule&year=${year}&month=all`;
            } else {
                window.location.href = `{{ url_for('schedule') }}?view=schedule&year=${year}&month=${month}`;
            }
        }
    });
    
    // Calendar navigation handlers
    let currentView = '{{ view_type|default("month") }}';
    let currentYear = 2025;
    let currentMonth = 1;
    let currentWeek = 1;
    
    function updateCalendar() {
        // This will be implemented to load calendar content dynamically
        console.log('Updating calendar view:', currentView);
    }
    
    document.getElementById('prevPeriod').addEventListener('click', function() {
        if (currentView === 'calendar-year') {
            currentYear--;
        } else if (currentView === 'calendar-month') {
            if (currentMonth === 1) {
                currentMonth = 12;
                currentYear--;
            } else {
                currentMonth--;
            }
        } else if (currentView === 'calendar-week') {
            currentWeek--;
            if (currentWeek < 1) {
                currentWeek = 52;
                currentYear--;
            }
        }
        updateCalendar();
    });
    
    document.getElementById('nextPeriod').addEventListener('click', function() {
        if (currentView === 'calendar-year') {
            currentYear++;
        } else if (currentView === 'calendar-month') {
            if (currentMonth === 12) {
                currentMonth = 1;
                currentYear++;
            } else {
                currentMonth++;
            }
        } else if (currentView === 'calendar-week') {
            currentWeek++;
            if (currentWeek > 52) {
                currentWeek = 1;
                currentYear++;
            }
        }
        updateCalendar();
    });
    
    document.getElementById('todayBtn').addEventListener('click', function() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        // Calculate current week
        const startOfYear = new Date(currentYear, 0, 1);
        const today_ms = today.getTime();
        const startOfYear_ms = startOfYear.getTime();
        currentWeek = Math.ceil(((today_ms - startOfYear_ms) / 86400000 + startOfYear.getDay() + 1) / 7);
        updateCalendar();
    });
});
</script>
{% endblock %}
