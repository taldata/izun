{% extends "base.html" %}

{% block title %}דף הבית - איזון עומסים{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="jumbotron text-white rounded p-5 mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold mb-3">
                        <img src="https://upload.wikimedia.org/wikipedia/he/c/c8/Israel_Innovation_Authority.svg" alt="לוגו" style="height: 60px; margin-left: 15px;">
                        איזון עומסים
                    </h1>
                    <p class="lead mb-4">פלטפורמה מתקדמת לניהול ישיבות וועדות, תזמון אירועים וארגון חטיבות</p>
                    <div class="d-flex gap-3">
                        <a href="{{ url_for('committees') }}" class="btn btn-light btn-lg rounded-pill px-4">
                            <i class="bi bi-plus-circle me-2"></i>צור ישיבה חדשה
                        </a>
                        <a href="{{ url_for('auto_schedule') }}" class="btn btn-outline-light btn-lg rounded-pill px-4">
                            <i class="bi bi-robot me-2"></i>תזמון אוטומטי
                        </a>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <i class="bi bi-calendar-week" style="font-size: 8rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-5">
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="stats-card card text-center h-100" style="border-left-color: #3498db;">
            <div class="card-body py-4">
                <i class="bi bi-diagram-3 text-primary mb-2" style="font-size: 2.5rem;"></i>
                <h3 class="fw-bold mb-1">{{ stats.hativot_count }}</h3>
                <p class="card-text text-muted small mb-0">חטיבות</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="stats-card card text-center h-100" style="border-left-color: #17a2b8;">
            <div class="card-body py-4">
                <i class="bi bi-arrow-right-circle text-info mb-2" style="font-size: 2.5rem;"></i>
                <h3 class="fw-bold mb-1">{{ stats.maslulim_count }}</h3>
                <p class="card-text text-muted small mb-0">מסלולים</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="stats-card card text-center h-100" style="border-left-color: #28a745;">
            <div class="card-body py-4">
                <i class="bi bi-people text-success mb-2" style="font-size: 2.5rem;"></i>
                <h3 class="fw-bold mb-1">{{ stats.committees_count }}</h3>
                <p class="card-text text-muted small mb-0">ישיבות מתוכננות</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="stats-card card text-center h-100" style="border-left-color: #ffc107;">
            <div class="card-body py-4">
                <i class="bi bi-calendar-event text-warning mb-2" style="font-size: 2.5rem;"></i>
                <h3 class="fw-bold mb-1">{{ stats.events_count }}</h3>
                <p class="card-text text-muted small mb-0">אירועים</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="stats-card card text-center h-100" style="border-left-color: #dc3545;">
            <div class="card-body py-4">
                <i class="bi bi-calendar-x text-danger mb-2" style="font-size: 2.5rem;"></i>
                <h3 class="fw-bold mb-1">{{ stats.exception_dates_count }}</h3>
                <p class="card-text text-muted small mb-0">תאריכי חריגים</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="stats-card card text-center h-100" style="border-left-color: #6c757d;">
            <div class="card-body py-4">
                <i class="bi bi-calendar3 text-secondary mb-2" style="font-size: 2.5rem;"></i>
                <h3 class="fw-bold mb-1">{{ stats.business_days_this_month }}</h3>
                <p class="card-text text-muted small mb-0">ימי עסקים החודש</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="section-title">
            <i class="bi bi-lightning me-2"></i>פעולות מהירות
        </h2>
    </div>
</div>

<div class="row mb-5">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="quick-action-card card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="bi bi-people-fill text-primary" style="font-size: 3.5rem;"></i>
                </div>
                <h5 class="card-title fw-bold">ישיבת ועדה חדשה</h5>
                <p class="card-text text-muted">תזמן ישיבה חדשה לחטיבה מסוימת</p>
                <a href="{{ url_for('committees') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus me-2"></i>צור ישיבה
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="quick-action-card card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="bi bi-calendar-event-fill text-success" style="font-size: 3.5rem;"></i>
                </div>
                <h5 class="card-title fw-bold">אירוע חדש</h5>
                <p class="card-text text-muted">הוסף אירוע לישיבה קיימת</p>
                <a href="{{ url_for('events') }}" class="btn btn-success btn-lg">
                    <i class="bi bi-plus me-2"></i>צור אירוע
                </a>
            </div>
        </div>
    </div>
    
    
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card action-card h-100 border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="action-icon bg-info bg-opacity-10 text-info mb-3">
                    <i class="bi bi-robot"></i>
                </div>
                <h5 class="card-title">תזמון אוטומטי</h5>
                <p class="card-text text-muted">יצירה אוטומטית של לוח זמנים חודשי</p>
                <a href="{{ url_for('auto_schedule') }}" class="btn btn-outline-info">
                    <i class="bi bi-arrow-left me-2"></i>כניסה
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card action-card h-100 border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="action-icon bg-warning bg-opacity-10 text-warning mb-3">
                    <i class="bi bi-gear-fill"></i>
                </div>
                <h5 class="card-title">הגדרות</h5>
                <p class="card-text text-muted">ניהול חטיבות, מסלולים ותאריכי חריגים</p>
                <a href="{{ url_for('hativot') }}" class="btn btn-outline-warning">
                    <i class="bi bi-arrow-left me-2"></i>כניסה
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Section -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title">
                <i class="bi bi-calendar3 me-2"></i>יומן ועדות ואירועים
            </h2>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" onclick="previousMonth()">
                    <i class="bi bi-chevron-right"></i>
                </button>
                <button class="btn btn-outline-primary" onclick="goToToday()">היום</button>
                <button class="btn btn-outline-primary" onclick="nextMonth()">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="currentMonthYear"></h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#addCommitteeModal">
                            <i class="bi bi-plus me-1"></i>ועדה
                        </button>
                        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#addEventModal">
                            <i class="bi bi-calendar-event me-1"></i>אירוע
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0" id="calendarTable">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center py-3">ראשון</th>
                                <th class="text-center py-3">שני</th>
                                <th class="text-center py-3">שלישי</th>
                                <th class="text-center py-3">רביעי</th>
                                <th class="text-center py-3">חמישי</th>
                                <th class="text-center py-3">שישי</th>
                                <th class="text-center py-3">שבת</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- Calendar days will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Committee Modal -->
<div class="modal fade" id="addCommitteeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-people me-2"></i>הוספת ישיבת ועדה
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_committee_meeting') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="committee_type_id" class="form-label">סוג ועדה</label>
                        <select class="form-select" name="committee_type_id" required>
                            <option value="">בחר סוג ועדה</option>
                            {% for committee_type in committee_types %}
                                <option value="{{ committee_type.committee_type_id }}">{{ committee_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="hativa_id" class="form-label">חטיבה</label>
                        <select class="form-select" name="hativa_id" required>
                            <option value="">בחר חטיבה</option>
                            {% for hativa in hativot %}
                                <option value="{{ hativa.hativa_id }}">{{ hativa.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vaada_date" class="form-label">תאריך הישיבה</label>
                        <input type="date" class="form-control" name="vaada_date" id="modalDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">הערות</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>צור ישיבה
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event me-2"></i>הוספת אירוע
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_event') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="event_vaadot_id" class="form-label">ישיבת ועדה</label>
                        <select class="form-select" name="vaadot_id" id="event_vaadot_id" required>
                            <option value="">בחר ישיבת ועדה</option>
                            {% for committee in committees %}
                                <option value="{{ committee.vaadot_id }}">
                                    {{ committee.committee_name }} - {{ committee.hativa_name }}
                                    {% if committee.vaada_date %} ({{ committee.vaada_date }}){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="event_maslul_id" class="form-label">מסלול</label>
                        <select class="form-select" name="maslul_id" id="event_maslul_id" required>
                            <option value="">בחר מסלול</option>
                            {% for maslul in maslulim %}
                                <option value="{{ maslul.maslul_id }}" data-hativa-id="{{ maslul.hativa_id }}">
                                    {{ maslul.name }} ({{ maslul.hativa_name }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="event_name" class="form-label">שם האירוע</label>
                        <input type="text" class="form-control" name="name" id="event_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="event_type" class="form-label">סוג האירוע</label>
                                <select class="form-select" name="event_type" required>
                                    <option value="">בחר סוג</option>
                                    <option value="kokok">קו"ק</option>
                                    <option value="shotef">שוטף</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expected_requests" class="form-label">בקשות צפויות</label>
                                <input type="number" class="form-control" name="expected_requests" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>צור אירוع
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Calendar functionality
let currentDate = new Date();
const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                   'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];

// Calendar data from server - using script tags to avoid Jinja2 conflicts
</script>
<script type="application/json" id="committees-data">{{ committees|tojson|safe }}</script>
<script type="application/json" id="events-data">{{ events|tojson|safe }}</script>
<script>
// Parse data from JSON scripts
const committeesData = JSON.parse(document.getElementById('committees-data').textContent);
const eventsData = JSON.parse(document.getElementById('events-data').textContent);

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update header
    document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Clear calendar body
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';
    
    let date = 1;
    
    // Create calendar rows
    for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
            const cell = document.createElement('td');
            cell.className = 'calendar-cell position-relative p-2';
            cell.style.height = '120px';
            cell.style.verticalAlign = 'top';
            
            if (week === 0 && day < startingDayOfWeek) {
                // Empty cells before first day
                cell.className += ' text-muted';
            } else if (date > daysInMonth) {
                // Empty cells after last day
                cell.className += ' text-muted';
            } else {
                // Regular day
                const dayDiv = document.createElement('div');
                dayDiv.className = 'fw-bold mb-1';
                dayDiv.textContent = date;
                
                // Check if today
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
                    dayDiv.className += ' text-primary';
                    cell.style.backgroundColor = '#e3f2fd';
                }
                
                cell.appendChild(dayDiv);
                
                // Add committees and events for this date
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                
                // Add committees
                committeesData.forEach(committee => {
                    if (committee.vaada_date === currentDateStr) {
                        const committeeDiv = document.createElement('div');
                        committeeDiv.className = 'badge bg-primary text-white mb-1 d-block text-truncate';
                        committeeDiv.style.fontSize = '0.7rem';
                        committeeDiv.textContent = committee.committee_name;
                        committeeDiv.title = `${committee.committee_name} - ${committee.hativa_name}`;
                        cell.appendChild(committeeDiv);
                    }
                });
                
                // Add events (grouped by committee)
                const dayEvents = eventsData.filter(event => {
                    const eventCommittee = committeesData.find(c => c.vaadot_id === event.vaadot_id);
                    return eventCommittee && eventCommittee.vaada_date === currentDateStr;
                });
                
                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'badge bg-success text-white mb-1 d-block text-truncate';
                    eventDiv.style.fontSize = '0.65rem';
                    eventDiv.textContent = event.name;
                    eventDiv.title = `${event.name} - ${event.maslul_name}`;
                    cell.appendChild(eventDiv);
                });
                
                // Make cell clickable for adding items
                cell.style.cursor = 'pointer';
                cell.onclick = function() {
                    document.getElementById('modalDate').value = currentDateStr;
                };
                
                date++;
            }
            
            row.appendChild(cell);
        }
        
        calendarBody.appendChild(row);
        
        // Stop if we've filled all days
        if (date > daysInMonth) break;
    }
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
}

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    renderCalendar();
    
    // Add click handler for calendar cells to set date in modals
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('calendar-cell') || e.target.closest('.calendar-cell')) {
            const cell = e.target.classList.contains('calendar-cell') ? e.target : e.target.closest('.calendar-cell');
            const dayElement = cell.querySelector('.fw-bold');
            if (dayElement) {
                const day = dayElement.textContent;
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                document.getElementById('modalDate').value = dateStr;
            }
        }
    });
});
</script>

<style>
.calendar-cell {
    min-height: 120px;
    border: 1px solid #dee2e6 !important;
}

.calendar-cell:hover {
    background-color: #f8f9fa !important;
}

.badge {
    font-size: 0.7rem;
    margin-bottom: 2px;
}

#calendarTable th {
    background-color: #f8f9fa;
    font-weight: 600;
}
</style>
{% endblock %}
