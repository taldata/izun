{% extends "base.html" %}

{% block title %}טבלת אירועים - איזון עומסים{% endblock %}

{% block extra_head %}
<style>
    .events-table-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .filter-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .filter-row {
        margin-bottom: 1rem;
    }
    
    .filter-row:last-child {
        margin-bottom: 0;
    }
    
    .events-table {
        font-size: 0.9rem;
    }
    
    .events-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .events-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .badge-event-type {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .badge-kokok {
        background-color: #dc3545;
    }
    
    .badge-shotef {
        background-color: #28a745;
    }
    
    .date-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        white-space: nowrap;
    }
    
    .date-call {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .date-intake {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .date-review {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .date-committee {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .date-response {
        background-color: #e0ecff;
        color: #0d47a1;
        border: 1px solid #bbdefb;
    }
    
    .date-publication {
        background-color: #f0f4c3;
        color: #558b2f;
        border: 1px solid #dce775;
    }
    
    .table-responsive {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .stats-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }
    
    /* Committee View Styles */
    .committee-view-section {
        padding: 1.5rem;
    }
    
    .committee-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .committee-table {
        margin-bottom: 0;
    }
    
    .committee-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .committee-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .committee-row:hover {
        background-color: #f8f9fa;
    }
    
    .committee-row.expanded {
        background-color: #e3f2fd;
    }
    
    .expand-button {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #6c757d;
        transition: transform 0.2s;
    }
    
    .expand-button:hover {
        color: #495057;
    }
    
    .expand-button.expanded {
        transform: rotate(90deg);
    }
    
    .events-row {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    .events-row td {
        padding: 1rem;
    }
    
    .event-item {
        background: white;
        margin-bottom: 0.5rem;
        padding: 0.75rem;
        border-radius: 5px;
        border-left: 3px solid #007bff;
        transition: box-shadow 0.2s;
    }
    
    .event-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .event-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .event-details {
        font-size: 0.85rem;
        color: #666;
    }
    
    .event-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }
    
    .badge-kokok {
        background-color: #dc3545;
        color: white;
    }
    
    .badge-shotef {
        background-color: #28a745;
        color: white;
    }
    
    .no-committees {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .events-container {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 1rem;
    }
    
    .events-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .events-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .events-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .events-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .clear-filters-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
    }
    
    .clear-filters-btn:hover {
        background: rgba(255,255,255,0.3);
        border: 1px solid rgba(255,255,255,0.5);
        color: white;
    }
    
    .export-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
    }
    
    .export-btn:hover {
        background: rgba(255,255,255,0.3);
        border: 1px solid rgba(255,255,255,0.5);
        color: white;
    }
    
    .view-toggle .btn {
        color: white;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    
    .view-toggle .btn:hover,
    .view-toggle .btn:focus {
        color: white;
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.85);
        box-shadow: none;
    }
    
    .view-toggle .btn-check:checked + .btn,
    .view-toggle .btn.active {
        color: #4a3fa6;
        background: #ffffff;
        border-color: #ffffff;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="events-table-container">
                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">
                            <i class="bi bi-table me-2"></i>טבלת אירועים ותאריכים
                        </h3>
                        <div class="d-flex gap-2">
                            <!-- View Toggle Buttons -->
                            <div class="btn-group view-toggle" role="group">
                                <input type="radio" class="btn-check" name="viewToggle" id="eventsView" autocomplete="off" checked>
                                <label class="btn btn-outline-primary btn-sm" for="eventsView">
                                    <i class="bi bi-list-ul me-1"></i>תצוגת אירועים
                                </label>

                                <input type="radio" class="btn-check" name="viewToggle" id="committeesView" autocomplete="off">
                                <label class="btn btn-outline-secondary btn-sm" for="committeesView">
                                    <i class="bi bi-grid-3x2 me-1"></i>תצוגת ועדות
                                </label>
                            </div>
                            <div id="emptyCommitteesToggle" class="form-check form-switch ms-2" style="opacity: 0; pointer-events: none;">
                                <input class="form-check-input" type="checkbox" id="includeEmptyCommittees" onchange="onEmptyCommitteesToggle()" disabled>
                                <label class="form-check-label text-white small" for="includeEmptyCommittees" style="cursor: default;">הצג ועדות ללא אירועים</label>
                            </div>
                            <button class="btn clear-filters-btn btn-sm" onclick="clearAllFilters()">
                                <i class="bi bi-x-circle me-1"></i>נקה פילטרים
                            </button>
                            <button class="btn export-btn btn-sm" onclick="exportToCSV()">
                                <i class="bi bi-download me-1"></i>ייצא ל-CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters Row 1 -->
                    <div class="filter-row">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">חטיבה</label>
                                <select class="form-select form-select-sm" id="filterHativa" onchange="filterTable()">
                                    <option value="">כל החטיבות</option>
                                    {% for hativa in hativot %}
                                        <option value="{{ hativa.hativa_id }}">{{ hativa.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">מסלול</label>
                                <select class="form-select form-select-sm" id="filterMaslul" onchange="filterTable()">
                                    <option value="">כל המסלולים</option>
                                    {% for maslul in maslulim %}
                                        <option value="{{ maslul.maslul_id }}" data-hativa="{{ maslul.hativa_id }}">{{ maslul.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">סוג ועדה</label>
                                <select class="form-select form-select-sm" id="filterCommitteeType" onchange="filterTable()">
                                    <option value="">כל סוגי הועדות</option>
                                    {% for committee_type in committee_types %}
                                        <option value="{{ committee_type.committee_type_id }}">{{ committee_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">סוג אירוע</label>
                                <select class="form-select form-select-sm" id="filterEventType" onchange="filterTable()">
                                    <option value="">כל סוגי האירועים</option>
                                    {% for event_type in event_types %}
                                        <option value="{{ event_type }}">
                                            {% if event_type == 'kokok' %}קו"ק{% elif event_type == 'shotef' %}שוטף{% else %}{{ event_type }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters Row 2 -->
                    <div class="filter-row">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">תאריך ועדה מ-</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateFrom" onchange="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">תאריך ועדה עד</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateTo" onchange="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">חיפוש טקסט</label>
                                <input type="text" class="form-control form-control-sm" id="filterText" placeholder="שם אירוע..." onkeyup="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">מספר בקשות מ-</label>
                                <input type="number" class="form-control form-control-sm" id="filterMinRequests" placeholder="0" onchange="filterTable()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Table Section -->
                <!-- Bulk Action Bar -->
                <div id="bulkActionBar" class="d-none p-2 border-bottom bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <strong id="selectedCount">0</strong> נבחרו
                    </div>
                    <div class="d-flex gap-2">
                        <button id="bulkDeleteEventsBtn" class="btn btn-sm btn-danger" onclick="confirmBulkDeleteEvents()">
                            <i class="bi bi-trash"></i> מחק אירועים נבחרים
                        </button>
                        <button id="bulkDeleteCommitteesBtn" class="btn btn-sm btn-danger d-none" onclick="confirmBulkDeleteCommittees()">
                            <i class="bi bi-trash"></i> מחק ועדות נבחרות (כולל אירועים)
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelections()">נקה בחירה</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover events-table mb-0" id="eventsTable">
                        <thead>
                            <tr>
                                <th style="width:36px;">
                                    <input type="checkbox" id="selectAllEvents" onchange="toggleSelectAllEvents(this)">
                                </th>
                                <th>שם האירוע</th>
                                <th>סוג</th>
                                <th>חטיבה</th>
                                <th>מסלול</th>
                                <th>ועדה</th>
                                <th>תאריך ועדה</th>
                                <th>פרסום קול קורא</th>
                                <th>סיום קול קורא</th>
                                <th>סיום קליטה</th>
                                <th>סיום בדיקה</th>
                                <th>תשובת ועדה</th>
                                <th>בקשות צפויות</th>
                                <th>הגשות בפועל</th>
                                <th>נוצר</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events %}
                            <tr data-event-id="{{ event.event_id }}"
                                data-hativa-id="{{ event.get('hativa_id', '') }}"
                                data-maslul-id="{{ event.maslul_id }}"
                                data-committee-type="{{ event.get('committee_type_id', '') }}"
                                data-event-type="{{ event.event_type or '' }}"
                                data-committee-date="{{ event.vaada_date or '' }}"
                                data-expected-requests="{{ event.expected_requests or 0 }}"
                                data-event-name="{{ event.name.lower() }}">
                                <td>
                                    <input type="checkbox" class="event-select" value="{{ event.event_id }}" onchange="onSelectionChanged()">
                                </td>
                                <td>
                                    <strong>{{ event.name }}</strong>
                                </td>
                                <td>
                                    {% if event.event_type %}
                                        <span class="badge badge-event-type {% if event.event_type == 'kokok' %}badge-kokok{% elif event.event_type == 'shotef' %}badge-shotef{% endif %}">
                                            {% if event.event_type == 'kokok' %}קו"ק{% elif event.event_type == 'shotef' %}שוטף{% else %}{{ event.event_type }}{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ event.hativa_name or '-' }}</td>
                                <td>{{ event.maslul_name or '-' }}</td>
                                <td>{{ event.committee_name or '-' }}</td>
                                <td>
                                    {% if event.vaada_date %}
                                        <span class="date-badge date-committee">{{ event.vaada_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.call_publication_date %}
                                        <span class="date-badge date-publication">{{ event.call_publication_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.call_deadline_date %}
                                        <span class="date-badge date-call">{{ event.call_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.intake_deadline_date %}
                                        <span class="date-badge date-intake">{{ event.intake_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.review_deadline_date %}
                                        <span class="date-badge date-review">{{ event.review_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.response_deadline_date %}
                                        <span class="date-badge date-response">{{ event.response_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ event.expected_requests or 0 }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ event.actual_submissions or 0 }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ event.created_at.strftime('%d/%m/%Y') if event.created_at else '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Stats Summary -->
                <div class="stats-summary">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <strong id="totalEvents">{{ events|length }}</strong>
                            <div class="text-muted small">סה"כ אירועים</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="visibleEvents">{{ events|length }}</strong>
                            <div class="text-muted small">אירועים מוצגים</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="totalRequests">
                                {% set total_requests = events|sum(attribute='expected_requests') %}
                                {{ total_requests or 0 }}
                            </strong>
                            <div class="text-muted small">סה"כ בקשות צפויות</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="totalSubmissions">
                                {% set total_submissions = events|sum(attribute='actual_submissions') %}
                                {{ total_submissions or 0 }}
                            </strong>
                            <div class="text-muted small">סה"כ הגשות בפועל</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="avgRequests">
                                {% if events|length > 0 %}
                                    {{ "%.1f"|format((events|sum(attribute='expected_requests') or 0) / events|length) }}
                                {% else %}
                                    0
                                {% endif %}
                            </strong>
                            <div class="text-muted small">ממוצע בקשות לאירוע</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="accuracyRate">
                                {% set total_expected = events|sum(attribute='expected_requests') or 0 %}
                                {% set total_actual = events|sum(attribute='actual_submissions') or 0 %}
                                {% if total_expected > 0 %}
                                    {{ "%.0f"|format((total_actual / total_expected) * 100) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </strong>
                            <div class="text-muted small">דיוק צפי</div>
                        </div>
                    </div>
                <!-- Committee View Section -->
                <div id="committeeView" class="committee-view-section" style="display: none;">
                    <div class="committee-table-container">
                        <table class="table table-hover committee-table" id="committeeTable">
                            <thead>
                                <tr>
                                    <th style="width:36px;">
                                        <input type="checkbox" id="selectAllCommittees" onchange="toggleSelectAllCommittees(this)">
                                    </th>
                                    <th width="5%"></th>
                                    <th>שם ועדה</th>
                                    <th>חטיבה</th>
                                    <th>סוג ועדה</th>
                                    <th>תאריך ועדה</th>
                                    <th>אירועים</th>
                                    <th>בקשות צפויות</th>
                                    <th>הגשות בפועל</th>
                                    <th>סוגי אירועים</th>
                                </tr>
                            </thead>
                            <tbody id="committeeTableBody">
                                <!-- Committee rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function filterTable() {
    const hativaFilter = document.getElementById('filterHativa').value;
    const maslulFilter = document.getElementById('filterMaslul').value;
    const committeeTypeFilter = document.getElementById('filterCommitteeType').value;
    const eventTypeFilter = document.getElementById('filterEventType').value;
    const dateFromFilter = document.getElementById('filterDateFrom').value;
    const dateToFilter = document.getElementById('filterDateTo').value;
    const textFilter = document.getElementById('filterText').value.toLowerCase();
    const minRequestsFilter = document.getElementById('filterMinRequests').value;
    
    const rows = document.querySelectorAll('#eventsTable tbody tr');
    let visibleCount = 0;
    let visibleRequests = 0;
    
    // Filter table rows
    rows.forEach(row => {
        let show = true;
        
        // Filter by hativa
        if (hativaFilter && row.dataset.hativaId !== hativaFilter) {
            show = false;
        }
        
        // Filter by maslul
        if (maslulFilter && row.dataset.maslulId !== maslulFilter) {
            show = false;
        }
        
        // Filter by committee type
        if (committeeTypeFilter && row.dataset.committeeType !== committeeTypeFilter) {
            show = false;
        }
        
        // Filter by event type
        if (eventTypeFilter && row.dataset.eventType !== eventTypeFilter) {
            show = false;
        }
        
        // Filter by date range
        if (dateFromFilter || dateToFilter) {
            const eventDate = row.dataset.committeeDate;
            if (eventDate) {
                if (dateFromFilter && eventDate < dateFromFilter) {
                    show = false;
                }
                if (dateToFilter && eventDate > dateToFilter) {
                    show = false;
                }
            } else if (dateFromFilter || dateToFilter) {
                show = false;
            }
        }
        
        // Filter by text
        if (textFilter && !row.dataset.eventName.includes(textFilter)) {
            show = false;
        }
        
        // Filter by minimum requests
        if (minRequestsFilter) {
            const requests = parseInt(row.dataset.expectedRequests) || 0;
            if (requests < parseInt(minRequestsFilter)) {
                show = false;
            }
        }
        
        // Show/hide row
        row.style.display = show ? '' : 'none';
        
        if (show) {
            visibleCount++;
            visibleRequests += parseInt(row.dataset.expectedRequests) || 0;
        }
    });
    
    // Update stats
    document.getElementById('visibleEvents').textContent = visibleCount;
    document.getElementById('totalRequests').textContent = visibleRequests;
    document.getElementById('avgRequests').textContent = visibleCount > 0 ? (visibleRequests / visibleCount).toFixed(1) : '0';
    
    // Update maslul filter based on hativa selection
    updateMaslulFilter();
}

function updateMaslulFilter() {
    const hativaFilter = document.getElementById('filterHativa').value;
    const maslulSelect = document.getElementById('filterMaslul');
    const currentMaslul = maslulSelect.value;
    
    // Show/hide maslul options based on hativa selection
    Array.from(maslulSelect.options).forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        
        if (!hativaFilter || option.dataset.hativa === hativaFilter) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
            if (option.value === currentMaslul) {
                maslulSelect.value = '';
            }
        }
    });
}

function clearAllFilters() {
    document.getElementById('filterHativa').value = '';
    document.getElementById('filterMaslul').value = '';
    document.getElementById('filterCommitteeType').value = '';
    document.getElementById('filterEventType').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterText').value = '';
    document.getElementById('filterMinRequests').value = '';
    
    filterTable();
}

function exportToCSV() {
    const table = document.getElementById('eventsTable');
    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
    
    let csv = 'שם האירוע,סוג,חטיבה,מסלול,ועדה,תאריך ועדה,סיום קול קורא,סיום קליטה,סיום בדיקה,תשובת ועדה,בקשות צפויות,נוצר\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => {
            let text = cell.textContent.trim();
            // Remove extra whitespace and normalize
            text = text.replace(/\s+/g, ' ');
            // Escape quotes and wrap in quotes if contains comma
            if (text.includes(',') || text.includes('"')) {
                text = '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        });
        csv += rowData.join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `events_table_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize filters on page load
document.addEventListener('DOMContentLoaded', function() {
    filterTable();

    // Initialize view toggle
    initializeViewToggle();

    // Initialize bulk bar visibility
    onSelectionChanged();
});

// View Toggle Functions
function initializeViewToggle() {
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');
    const eventsTable = document.getElementById('eventsTable').closest('.table-responsive');
    const committeeView = document.getElementById('committeeView');

    eventsViewRadio.addEventListener('change', function() {
        if (this.checked) {
            eventsTable.style.display = 'block';
            committeeView.style.display = 'none';
            // Re-apply filters to table
            filterTable();
            document.getElementById('bulkDeleteEventsBtn').classList.remove('d-none');
            document.getElementById('bulkDeleteCommitteesBtn').classList.add('d-none');
            // Hide toggle but keep space
            const toggle = document.getElementById('emptyCommitteesToggle');
            toggle.style.opacity = '0';
            toggle.style.pointerEvents = 'none';
            document.getElementById('includeEmptyCommittees').disabled = true;
        }
    });

    committeesViewRadio.addEventListener('change', function() {
        if (this.checked) {
            eventsTable.style.display = 'none';
            committeeView.style.display = 'block';
            // Load committee view
            loadCommitteeView();
            document.getElementById('bulkDeleteEventsBtn').classList.add('d-none');
            document.getElementById('bulkDeleteCommitteesBtn').classList.remove('d-none');
            // Show toggle
            const toggle = document.getElementById('emptyCommitteesToggle');
            toggle.style.opacity = '1';
            toggle.style.pointerEvents = 'auto';
            document.getElementById('includeEmptyCommittees').disabled = false;
        }
    });
}

async function loadCommitteeView() {
    const container = document.getElementById('committeeTableBody');
    const includeEmpty = document.getElementById('includeEmptyCommittees').checked;

    try {
        // Show loading state
        container.innerHTML = '<tr><td colspan="9" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">טוען...</span></div></td></tr>';

        // Fetch committee data from API
        const response = await fetch('/api/events_by_committee' + (includeEmpty ? '?include_empty=1' : ''));
        const data = await response.json();

        if (data.success) {
            renderCommitteeTable(data.events_by_committee);
        } else {
            container.innerHTML = `<tr><td colspan="9" class="text-center">
                <div class="no-committees">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>שגיאה בטעינת נתוני הועדות</h5>
                    <p>${data.error}</p>
                </div>
            </td></tr>`;
        }
    } catch (error) {
        container.innerHTML = `<tr><td colspan="9" class="text-center">
            <div class="no-committees">
                <i class="bi bi-exclamation-triangle"></i>
                <h5>שגיאה בחיבור לשרת</h5>
                <p>אנא נסה שוב מאוחר יותר</p>
            </div>
        </td></tr>`;
    }
}

function renderCommitteeTable(committees) {
    const tbody = document.getElementById('committeeTableBody');

    if (!committees || committees.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center">
            <div class="no-committees">
                <i class="bi bi-calendar-x"></i>
                <h5>אין ועדות עם אירועים</h5>
                <p>צור אירועים כדי לראות אותם מקובצים לפי ועדות</p>
            </div>
        </td></tr>`;
        return;
    }

    let html = '';
    committees.forEach(committee => {
        const eventTypes = committee.summary.event_types.length > 0 ?
            committee.summary.event_types.map(type => {
                if (type === 'kokok') return '<span class="badge badge-kokok">קו"ק</span>';
                if (type === 'shotef') return '<span class="badge badge-shotef">שוטף</span>';
                return `<span class="badge bg-secondary">${type}</span>`;
            }).join(' ') : '<span class="text-muted">אין סוגים</span>';

        html += `
            <tr class="committee-row" data-committee-id="${committee.committee_info.vaadot_id}">
                <td>
                    <input type="checkbox" class="committee-select" value="${committee.committee_info.vaadot_id}" onchange="onSelectionChanged()">
                </td>
                <td>
                    <button class="expand-button" onclick="toggleCommitteeRow('${committee.committee_info.vaadot_id}')" data-expanded="false">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </td>
                <td>${committee.committee_info.committee_name}</td>
                <td>${committee.committee_info.hativa_name}</td>
                <td>${committee.committee_info.committee_type}</td>
                <td>${formatDate(committee.committee_info.vaada_date)}</td>
                <td><span class="badge bg-primary">${committee.summary.total_events}</span></td>
                <td><strong>${committee.summary.total_expected_requests}</strong></td>
                <td><strong>${committee.summary.total_actual_submissions}</strong></td>
                <td>${eventTypes}</td>
            </tr>
            <tr class="events-row" id="events-${committee.committee_info.vaadot_id}" style="display: none;">
                <td colspan="9">
                    <div class="events-container">
                        ${committee.events.map(event => `
                            <div class="event-item">
                                <div class="event-name">${event.name}</div>
                                <div class="event-details">
                                    <strong>מסלול:</strong> ${event.maslul_name} •
                                    <strong>בקשות צפויות:</strong> ${event.expected_requests} •
                                    <strong>הגשות בפועל:</strong> ${event.actual_submissions || 0}
                                    ${event.event_type ? `• <span class="badge ${event.event_type === 'kokok' ? 'badge-kokok' : 'badge-shotef'}">${event.event_type === 'kokok' ? 'קו"ק' : 'שוטף'}</span>` : ''}
                                </div>
                                <div class="event-details mt-2">
                                    <strong>תאריכים:</strong>
                                    ${event.call_deadline_date ? `סיום קול קורא: ${formatDate(event.call_deadline_date)} • ` : ''}
                                    ${event.intake_deadline_date ? `סיום קליטה: ${formatDate(event.intake_deadline_date)} • ` : ''}
                                    ${event.review_deadline_date ? `סיום בדיקה: ${formatDate(event.review_deadline_date)}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function toggleCommitteeRow(committeeId) {
    const button = document.querySelector(`[data-committee-id="${committeeId}"] .expand-button`);
    const eventsRow = document.getElementById(`events-${committeeId}`);
    const icon = button.querySelector('i');

    const isExpanded = button.dataset.expanded === 'true';

    if (isExpanded) {
        // Collapse
        eventsRow.style.display = 'none';
        button.dataset.expanded = 'false';
        icon.className = 'bi bi-chevron-right';
        button.closest('.committee-row').classList.remove('expanded');
    } else {
        // Expand
        eventsRow.style.display = 'table-row';
        button.dataset.expanded = 'true';
        icon.className = 'bi bi-chevron-down';
        button.closest('.committee-row').classList.add('expanded');
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'תאריך לא ידוע';

    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('he-IL', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (e) {
        return dateStr;
    }
}

// Update export function to handle committee view
function exportToCSV() {
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');

    if (committeesViewRadio.checked) {
        exportCommitteeViewToCSV();
    } else {
        // Original export logic for events table
        const table = document.getElementById('eventsTable');
        const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');

        let csv = 'שם האירוע,סוג,חטיבה,מסלול,ועדה,תאריך ועדה,סיום קול קורא,סיום קליטה,סיום בדיקה,תשובת ועדה,בקשות צפויות,נוצר\n';

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = Array.from(cells).map(cell => {
                let text = cell.textContent.trim();
                text = text.replace(/\s+/g, ' ');
                if (text.includes(',') || text.includes('"')) {
                    text = '"' + text.replace(/"/g, '""') + '"';
                }
                return text;
            });
            csv += rowData.join(',') + '\n';
        });

        downloadCSV(csv, `events_table_${new Date().toISOString().split('T')[0]}.csv`);
    }
}

async function exportCommitteeViewToCSV() {
    try {
        const response = await fetch('/api/events_by_committee');
        const data = await response.json();

        if (!data.success) {
            alert('שגיאה בטעינת נתוני הועדות לייצוא');
            return;
        }

        let csv = 'שם ועדה,חטיבה,סוג ועדה,תאריך ועדה,מספר אירועים,בקשות צפויות,הגשות בפועל,סוגי אירועים,פרטי אירועים\n';

        data.events_by_committee.forEach(committee => {
            const eventTypes = committee.summary.event_types.join('; ');
            const eventsDetails = committee.events.map(event =>
                `"${event.name} (${event.maslul_name}, ${event.expected_requests} בקשות${event.event_type ? ', ' + (event.event_type === 'kokok' ? 'קו"ק' : 'שוטף') : ''})"`
            ).join('; ');

            const rowData = [
                committee.committee_info.committee_name,
                committee.committee_info.hativa_name,
                committee.committee_info.committee_type,
                committee.committee_info.vaada_date || '',
                committee.summary.total_events,
                committee.summary.total_expected_requests,
                committee.summary.total_actual_submissions,
                eventTypes,
                eventsDetails
            ];

            csv += rowData.map(field => {
                const text = String(field || '');
                return text.includes(',') || text.includes('"') || text.includes('\n') ?
                    '"' + text.replace(/"/g, '""') + '"' : text;
            }).join(',') + '\n';
        });

        downloadCSV(csv, `committees_detailed_${new Date().toISOString().split('T')[0]}.csv`);
    } catch (error) {
        alert('שגיאה בייצוא נתוני הועדות');
    }
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Bulk selection / actions
function onEmptyCommitteesToggle() {
    const committeesViewRadio = document.getElementById('committeesView');
    if (committeesViewRadio.checked) {
        loadCommitteeView();
    }
}
function getSelectedEventIds() {
    return Array.from(document.querySelectorAll('.event-select:checked'))
        .map(cb => parseInt(cb.value))
        .filter(Number.isFinite);
}

function getSelectedCommitteeIds() {
    return Array.from(document.querySelectorAll('.committee-select:checked'))
        .map(cb => parseInt(cb.value))
        .filter(Number.isFinite);
}

function onSelectionChanged() {
    const eventsSelected = getSelectedEventIds().length;
    const committeesSelected = getSelectedCommitteeIds().length;
    const total = eventsSelected + committeesSelected;
    const bar = document.getElementById('bulkActionBar');
    const selectedCount = document.getElementById('selectedCount');
    if (total > 0) {
        bar.classList.remove('d-none');
        selectedCount.textContent = total;
    } else {
        bar.classList.add('d-none');
        selectedCount.textContent = '0';
    }
}

function toggleSelectAllEvents(master) {
    const visibleRows = Array.from(document.querySelectorAll('#eventsTable tbody tr'))
        .filter(row => row.style.display !== 'none');
    visibleRows.forEach(row => {
        const cb = row.querySelector('.event-select');
        if (cb) cb.checked = master.checked;
    });
    onSelectionChanged();
}

function toggleSelectAllCommittees(master) {
    const visibleRows = Array.from(document.querySelectorAll('#committeeTableBody .committee-row'));
    visibleRows.forEach(row => {
        const cb = row.querySelector('.committee-select');
        if (cb) cb.checked = master.checked;
    });
    onSelectionChanged();
}

function clearSelections() {
    document.querySelectorAll('.event-select, .committee-select').forEach(cb => cb.checked = false);
    const selectAllEvents = document.getElementById('selectAllEvents');
    const selectAllCommittees = document.getElementById('selectAllCommittees');
    if (selectAllEvents) selectAllEvents.checked = false;
    if (selectAllCommittees) selectAllCommittees.checked = false;
    onSelectionChanged();
}

async function confirmBulkDeleteEvents() {
    const ids = getSelectedEventIds();
    if (ids.length === 0) return;
    if (!confirm(`האם למחוק ${ids.length} אירועים שנבחרו?`)) return;
    await bulkDeleteEvents(ids);
}

async function confirmBulkDeleteCommittees() {
    const ids = getSelectedCommitteeIds();
    if (ids.length === 0) return;
    if (!confirm(`האם למחוק ${ids.length} ועדות שנבחרו (כולל כל האירועים שלהן)?`)) return;
    await bulkDeleteCommittees(ids);
}

async function bulkDeleteEvents(eventIds) {
    try {
        const res = await fetch('/api/events/bulk_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event_ids: eventIds })
        });
        const data = await res.json();
        if (data.success) {
            // Remove deleted rows from table
            eventIds.forEach(id => {
                const row = document.querySelector(`#eventsTable tbody tr[data-event-id="${id}"]`);
                if (row) row.remove();
            });
            clearSelections();
            filterTable();
            alert(`נמחקו ${data.deleted_count} אירועים`);
        } else {
            alert(data.message || 'שגיאה במחיקה מרובה');
        }
    } catch (e) {
        alert('שגיאה בביצוע הבקשה');
    }
}

async function bulkDeleteCommittees(vaadotIds) {
    try {
        const res = await fetch('/api/committees/bulk_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vaadot_ids: vaadotIds })
        });
        const data = await res.json();
        if (data.success) {
            // Refresh committee view
            loadCommitteeView();
            clearSelections();
            alert(`נמחקו ${data.deleted_committees} ועדות ו-${data.deleted_events} אירועים`);
        } else {
            alert(data.message || 'שגיאה במחיקה מרובה');
        }
    } catch (e) {
        alert('שגיאה בביצוע הבקשה');
    }
}
</script>
{% endblock %}
