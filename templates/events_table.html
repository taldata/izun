{% extends "base.html" %}

{% block title %}טבלת אירועים - איזון עומסים{% endblock %}

{% block extra_head %}
<!-- SheetJS library for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
    .events-table-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .filter-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .filter-row {
        margin-bottom: 1rem;
    }
    
    .filter-row:last-child {
        margin-bottom: 0;
    }
    
    .events-table {
        font-size: 0.9rem;
    }
    
    .events-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .events-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .badge-event-type {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .badge-kokok {
        background-color: #dc3545;
    }
    
    .badge-shotef {
        background-color: #28a745;
    }
    
    .date-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        white-space: nowrap;
        direction: ltr;
        display: inline-block;
    }
    
    .date-call {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .date-call-manual {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        position: relative;
    }
    
    .manual-indicator {
        font-size: 0.7rem;
        margin-right: 0.25rem;
        vertical-align: middle;
    }
    
    .date-intake {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .date-review {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .date-committee {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .date-response {
        background-color: #e0ecff;
        color: #0d47a1;
        border: 1px solid #bbdefb;
    }
    
    .date-publication {
        background-color: #f0f4c3;
        color: #558b2f;
        border: 1px solid #dce775;
    }
    
    .table-responsive {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .stats-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }
    
    /* Committee View Styles */
    .committee-view-section {
        padding: 1.5rem;
    }
    
    .committee-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .committee-table {
        margin-bottom: 0;
    }
    
    .committee-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .committee-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .committee-row:hover {
        background-color: #f8f9fa;
    }
    
    .committee-row.expanded {
        background-color: #e3f2fd;
    }
    
    .expand-button {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #6c757d;
        transition: transform 0.2s;
    }
    
    .expand-button:hover {
        color: #495057;
    }
    
    .expand-button.expanded {
        transform: rotate(90deg);
    }
    
    .events-row {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    .events-row td {
        padding: 1rem;
    }
    
    .event-item {
        background: white;
        margin-bottom: 0.5rem;
        padding: 0.75rem;
        border-radius: 5px;
        border-left: 3px solid #007bff;
        transition: box-shadow 0.2s;
    }
    
    .event-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .event-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .event-details {
        font-size: 0.85rem;
        color: #666;
    }
    
    .event-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }
    
    .badge-kokok {
        background-color: #dc3545;
        color: white;
    }
    
    .badge-shotef {
        background-color: #28a745;
        color: white;
    }
    
    .no-committees {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .events-container {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 1rem;
    }
    
    .events-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .events-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .events-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .events-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .clear-filters-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
    }
    
    .clear-filters-btn:hover {
        background: rgba(255,255,255,0.3);
        border: 1px solid rgba(255,255,255,0.5);
        color: white;
    }
    
    .export-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
    }
    
    .export-btn:hover {
        background: rgba(255,255,255,0.3);
        border: 1px solid rgba(255,255,255,0.5);
        color: white;
    }
    
    .view-toggle .btn {
        color: white;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    
    .view-toggle .btn:hover,
    .view-toggle .btn:focus {
        color: white;
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.85);
        box-shadow: none;
    }
    
    .view-toggle .btn-check:checked + .btn,
    .view-toggle .btn.active {
        color: #4a3fa6;
        background: #ffffff;
        border-color: #ffffff;
        box-shadow: none;
    }
    .sort-controls{
        display: inline-flex;
        align-items: center;
        gap: 2px;
        white-space: nowrap;
        vertical-align: middle;
        font-size: .85rem;
    }
    .sort-controls .btn{
        line-height: 1;
        padding: 0 .25rem;
        border: 0;
        background: transparent;
        color: #6c757d;
    }
    .sort-controls .btn:hover{
        color: #343a40;
        background: transparent;
    }
    .sort-controls .btn.active{
        color: #0d6efd;
        font-weight: 700;
        text-shadow: 0 0 0 currentColor;
    }

    /* Force LTR direction for all date displays */
    .events-table td:nth-child(7),  /* פרסום קול קורא */
    .events-table td:nth-child(8),  /* סיום קול קורא */
    .events-table td:nth-child(9),  /* סיום קליטה */
    .events-table td:nth-child(10), /* סיום בדיקה */
    .events-table td:nth-child(11), /* תאריך ועדה */
    .events-table td:nth-child(12), /* תשובת ועדה */
    .events-table td:nth-child(14), /* נוצר */
    .committee-table td:nth-child(6) /* תאריך ועדה in committee view */ {
        direction: ltr;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="events-table-container">
                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">
                            <i class="bi bi-table me-2"></i>טבלת אירועים ותאריכים
                        </h3>
                        <div class="d-flex gap-2">
                            <!-- View Toggle Buttons -->
                            <div class="btn-group view-toggle" role="group">
                                <input type="radio" class="btn-check" name="viewToggle" id="eventsView" autocomplete="off" checked>
                                <label class="btn btn-outline-primary btn-sm" for="eventsView">
                                    <i class="bi bi-list-ul me-1"></i>תצוגת אירועים
                                </label>

                                <input type="radio" class="btn-check" name="viewToggle" id="committeesView" autocomplete="off">
                                <label class="btn btn-outline-secondary btn-sm" for="committeesView">
                                    <i class="bi bi-grid-3x2 me-1"></i>תצוגת ועדות
                                </label>
                            </div>
                            <button class="btn clear-filters-btn btn-sm" onclick="clearAllFilters()">
                                <i class="bi bi-x-circle me-1"></i>נקה פילטרים
                            </button>
                            <!-- Export button -->
                            <button class="btn export-btn btn-sm" onclick="exportToExcel()">
                                <i class="bi bi-file-earmark-excel me-1"></i>ייצא ל-Excel
                            </button>
                            <button class="btn export-btn btn-sm" onclick="exportToPDF()">
                                <i class="bi bi-file-earmark-pdf me-1"></i>ייצא ל-PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters Row 1 -->
                    <div class="filter-row">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">חטיבה</label>
                                <select class="form-select form-select-sm" id="filterHativa" onchange="onHativaFilterChange()">
                                    <option value="">כל החטיבות</option>
                                    {% for hativa in hativot %}
                                        <option value="{{ hativa.hativa_id }}">{{ hativa.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">מסלול</label>
                                <select class="form-select form-select-sm" id="filterMaslul" onchange="filterTable()" disabled>
                                    <option value="">כל המסלולים</option>
                                    {% for maslul in maslulim %}
                                        <option value="{{ maslul.maslul_id }}" data-hativa="{{ maslul.hativa_id }}">{{ maslul.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">יש לבחור חטיבה תחילה</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">סוג ועדה</label>
                                <select class="form-select form-select-sm" id="filterCommitteeType" onchange="filterTable()" disabled>
                                    <option value="">כל סוגי הועדות</option>
                                    {% for committee_type in committee_types %}
                                        <option value="{{ committee_type.committee_type_id }}" data-hativa="{{ committee_type.hativa_id }}">{{ committee_type.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">יש לבחור חטיבה תחילה</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">סוג אירוע</label>
                                <select class="form-select form-select-sm" id="filterEventType" onchange="filterTable()">
                                    <option value="">כל סוגי האירועים</option>
                                    {% for event_type in event_types %}
                                        <option value="{{ event_type }}">
                                            {% if event_type == 'kokok' %}קו"ק{% elif event_type == 'shotef' %}שוטף{% else %}{{ event_type }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters Row 2 -->
                    <div class="filter-row">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">תאריך ועדה מ-</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateFrom" onchange="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">תאריך ועדה עד</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateTo" onchange="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">חיפוש טקסט בשם האירוע</label>
                                <input type="text" class="form-control form-control-sm" id="filterText" placeholder="שם אירוע..." onkeyup="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">מספר בקשות</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light">מ-</span>
                                    <input type="number" class="form-control" id="filterMinRequests" placeholder="0" min="0" onchange="filterTable()">
                                    <span class="input-group-text bg-light">עד</span>
                                    <input type="number" class="form-control" id="filterMaxRequests" placeholder="ללא הגבלה" min="0" onchange="filterTable()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Table Section -->
                <!-- Bulk Action Bar -->
                <div id="bulkActionBar" class="d-none p-2 border-bottom bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <strong id="selectedCount">0</strong> נבחרו
                    </div>
                    <div class="d-flex gap-2">
                        <button id="bulkDeleteEventsBtn" class="btn btn-sm btn-danger" onclick="confirmBulkDeleteEvents()">
                            <i class="bi bi-trash"></i> מחק אירועים נבחרים
                        </button>
                        <button id="bulkDeleteCommitteesBtn" class="btn btn-sm btn-danger d-none" onclick="confirmBulkDeleteCommittees()">
                            <i class="bi bi-trash"></i> מחק ועדות נבחרות (כולל אירועים)
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelections()">נקה בחירה</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover events-table mb-0" id="eventsTable">
                        <thead>
                            <tr>
                                <th style="width:36px;">
                                    <input type="checkbox" id="selectAllEvents" onchange="toggleSelectAllEvents(this)">
                                </th>
                                <th>
                                    חטיבה
                                </th>
                                <th>
                                    מסלול
                                </th>
                                <th>
                                    שם האירוע
                                </th>
                                <th>
                                    סוג
                                </th>
                                <th>
                                    בקשות צפויות
                                </th>
                                <th>
                                    פרסום קול קורא
                                </th>
                                <th>
                                    סיום קול קורא
                                    <span class="ms-1 sort-controls">
                                        <button type="button" class="btn btn-light btn-sm py-0 px-1" title="מיון עולה" data-sort-key="callDeadline" data-sort-dir="asc" onclick="setSort('callDeadline','asc')">▲</button>
                                        <button type="button" class="btn btn-light btn-sm py-0 px-1" title="מיון יורד" data-sort-key="callDeadline" data-sort-dir="desc" onclick="setSort('callDeadline','desc')">▼</button>
                                    </span>
                                </th>
                                <th>
                                    סיום קליטה
                                </th>
                                <th>
                                    סיום בדיקה
                                </th>
                                <th>
                                    תאריך ועדה
                                    <span class="ms-1 sort-controls">
                                        <button type="button" class="btn btn-light btn-sm py-0 px-1" title="מיון עולה" data-sort-key="committeeDate" data-sort-dir="asc" onclick="setSort('committeeDate','asc')">▲</button>
                                        <button type="button" class="btn btn-light btn-sm py-0 px-1" title="מיון יורד" data-sort-key="committeeDate" data-sort-dir="desc" onclick="setSort('committeeDate','desc')">▼</button>
                                    </span>
                                </th>
                                <th>
                                    תשובת ועדה
                                </th>
                                <th>
                                    בקשות בפועל
                                </th>
                                <th>
                                    נוצר
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events %}
                            <tr data-event-id="{{ event.event_id }}"
                                data-hativa-id="{{ event.get('maslul_hativa_id') or '' }}"
                                data-maslul-id="{{ event.maslul_id or '' }}"
                                data-committee-type="{{ event.get('committee_type_id') or '' }}"
                                data-event-type="{{ event.event_type or '' }}"
                                data-event-type-name="{{ event.event_type or '' }}"
                                data-committee-date="{{ event.vaada_date or '' }}"
                                data-call-publication="{{ event.call_publication_date or '' }}"
                                data-call-deadline="{{ event.call_deadline_date or '' }}"
                                data-intake-deadline="{{ event.intake_deadline_date or '' }}"
                                data-review-deadline="{{ event.review_deadline_date or '' }}"
                                data-committee-name="{{ event.committee_name or '' }}"
                                data-response-deadline="{{ event.response_deadline_date or '' }}"
                                data-expected-requests="{{ event.expected_requests or 0 }}"
                                data-actual-submissions="{{ event.actual_submissions or 0 }}"
                                data-event-name="{{ event.name.lower() }}"
                                data-hativa-name="{{ event.hativa_name or '' }}"
                                data-maslul-name="{{ event.maslul_name or '' }}"
                                data-created-at="{{ event.created_at.strftime('%Y-%m-%d %H:%M:%S') if event.created_at else '' }}">
                                <td>
                                    <input type="checkbox" class="event-select" value="{{ event.event_id }}" onchange="onSelectionChanged()">
                                </td>
                                <td>
                                    {{ event.hativa_name or '-' }}
                                </td>
                                <td>
                                    {{ event.maslul_name or '-' }}
                                </td>
                                <td>
                                    <strong>{{ event.name }}</strong>
                                </td>
                                <td>
                                    {% if event.event_type %}
                                        <span class="badge badge-event-type {% if event.event_type == 'kokok' %}badge-kokok{% elif event.event_type == 'shotef' %}badge-shotef{% endif %}">
                                            {% if event.event_type == 'kokok' %}קו"ק{% elif event.event_type == 'shotef' %}שוטף{% else %}{{ event.event_type }}{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ event.expected_requests or 0 }}</span>
                                </td>
                                <td>
                                    {% if event.call_publication_date %}
                                        <span class="date-badge date-publication">{{ event.call_publication_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.call_deadline_date %}
                                        {% set is_manual = event.get('is_call_deadline_manual') == 1 or event.get('is_call_deadline_manual') == True %}
                                        <span class="date-badge {% if is_manual %}date-call-manual{% else %}date-call{% endif %}" 
                                              {% if is_manual %}title="תאריך זה שונה ידנית"{% endif %}>
                                            {% if is_manual %}
                                                <i class="bi bi-pencil-square manual-indicator" title="תאריך שונה ידנית"></i>
                                            {% endif %}
                                            {{ event.call_deadline_date }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.intake_deadline_date %}
                                        <span class="date-badge date-intake">{{ event.intake_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.review_deadline_date %}
                                        <span class="date-badge date-review">{{ event.review_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.vaada_date %}
                                        <span class="date-badge date-committee">{{ event.vaada_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.response_deadline_date %}
                                        <span class="date-badge date-response">{{ event.response_deadline_date }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ event.actual_submissions or 0 }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ event.created_at.strftime('%d/%m/%Y') if event.created_at else '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Stats Summary -->
                <div class="stats-summary">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <strong id="totalEvents">{{ events|length }}</strong>
                            <div class="text-muted small">סה"כ אירועים</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="visibleEvents">{{ events|length }}</strong>
                            <div class="text-muted small">אירועים מוצגים</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="totalRequests">
                                {% set total_requests = events|sum(attribute='expected_requests') %}
                                {{ total_requests or 0 }}
                            </strong>
                            <div class="text-muted small">סה"כ בקשות צפויות</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="totalSubmissions">
                                {% set total_submissions = events|sum(attribute='actual_submissions') %}
                                {{ total_submissions or 0 }}
                            </strong>
                            <div class="text-muted small">סה\"כ בקשות בפועל</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="avgRequests">
                                {% if events|length > 0 %}
                                    {{ "%.1f"|format((events|sum(attribute='expected_requests') or 0) / events|length) }}
                                {% else %}
                                    0
                                {% endif %}
                            </strong>
                            <div class="text-muted small">ממוצע בקשות לאירוע</div>
                        </div>
                        <div class="col-md-2">
                            <strong id="accuracyRate">
                                {% set total_expected = events|sum(attribute='expected_requests') or 0 %}
                                {% set total_actual = events|sum(attribute='actual_submissions') or 0 %}
                                {% if total_expected > 0 %}
                                    {{ "%.0f"|format((total_actual / total_expected) * 100) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </strong>
                            <div class="text-muted small">דיוק צפי</div>
                        </div>
                    </div>
                <!-- Committee View Section -->
                <div id="committeeView" class="committee-view-section" style="display: none;">
                    <div class="committee-table-container">
                        <table class="table table-hover committee-table" id="committeeTable">
                            <thead>
                                <tr>
                                    <th style="width:36px;">
                                        <input type="checkbox" id="selectAllCommittees" onchange="toggleSelectAllCommittees(this)">
                                    </th>
                                    <th width="5%"></th>
                                    <th>שם ועדה</th>
                                    <th>חטיבה</th>
                                    <th>סוג ועדה</th>
                                    <th>תאריך ועדה</th>
                                    <th>אירועים</th>
                                    <th>בקשות צפויות</th>
                                    <th>בקשות בפועל</th>
                                    <th>סוגי אירועים</th>
                                </tr>
                            </thead>
                            <tbody id="committeeTableBody">
                                <!-- Committee rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>

let currentSort = { key: null, dir: 'asc' };

function setSort(key, dir) {
    currentSort = { key, dir: dir === 'desc' ? 'desc' : 'asc' };
    sortEventsTable();
    updateSortIndicators();
}

function applyCurrentSort() {
    if (currentSort.key) {
        sortEventsTable();
        updateSortIndicators();
    }
}

function sortEventsTable() {
    const tbody = document.querySelector('#eventsTable tbody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (rows.length === 0) return;

    const key = currentSort.key;
    const dir = currentSort.dir;

    const toNum = (v) => {
        const n = parseFloat(v);
        return Number.isFinite(n) ? n : null;
    };

    const getValue = (row) => {
        if (key === 'committeeDate') {
            const v = row.dataset.committeeDate;
            if (!v) return null; // missing dates should be last
            const t = Date.parse(v);
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'callDeadline') {
            const v = row.dataset.callDeadline;
            if (!v) return null;
            const t = Date.parse(v);
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'callPublication') {
            const v = row.dataset.callPublication;
            if (!v) return null;
            const t = Date.parse(v);
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'intakeDeadline') {
            const v = row.dataset.intakeDeadline;
            if (!v) return null;
            const t = Date.parse(v);
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'reviewDeadline') {
            const v = row.dataset.reviewDeadline;
            if (!v) return null;
            const t = Date.parse(v);
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'responseDeadline') {
            const v = row.dataset.responseDeadline;
            if (!v) return null;
            const t = Date.parse(v);
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'createdAt') {
            const v = row.dataset.createdAt;
            if (!v) return null;
            const t = Date.parse(v.replace(' ', 'T'));
            return Number.isFinite(t) ? t : null;
        }
        if (key === 'expectedRequests') {
            return toNum(row.dataset.expectedRequests);
        }
        if (key === 'actualSubmissions') {
            return toNum(row.dataset.actualSubmissions);
        }
        if (key === 'eventName') {
            return (row.dataset.eventName || '').toString();
        }
        if (key === 'eventType') {
            return (row.dataset.eventTypeName || '').toString();
        }
        if (key === 'hativaName') {
            return (row.dataset.hativaName || '').toString();
        }
        if (key === 'maslulName') {
            return (row.dataset.maslulName || '').toString();
        }
        if (key === 'committeeName') {
            return (row.dataset.committeeName || '').toString();
        }
        return null;
    };

    rows.sort((a, b) => {
        const va = getValue(a);
        const vb = getValue(b);

        // Missing values always go last
        const aMissing = (va === null || va === undefined || va === '');
        const bMissing = (vb === null || vb === undefined || vb === '');
        if (aMissing && bMissing) return 0;
        if (aMissing) return 1;
        if (bMissing) return -1;

        let cmp = 0;
        if (typeof va === 'number' && typeof vb === 'number') {
            cmp = va - vb;
        } else {
            cmp = String(va).localeCompare(String(vb), 'he');
        }
        return dir === 'desc' ? -cmp : cmp;
    });

    // Re-append in new order
    const frag = document.createDocumentFragment();
    rows.forEach(r => frag.appendChild(r));
    tbody.appendChild(frag);
}

function updateSortIndicators() {
    try {
        const { key, dir } = currentSort;
        document.querySelectorAll('.sort-controls .btn').forEach(btn => btn.classList.remove('active'));
        if (!key || !dir) return;
        const selector = `.sort-controls .btn[data-sort-key="${key}"][data-sort-dir="${dir}"]`;
        document.querySelectorAll(selector).forEach(btn => btn.classList.add('active'));
    } catch (e) {}
}

function onHativaFilterChange() {
    updateMaslulFilter();
    updateCommitteeTypeFilter();
    filterTable();
}
window.onHativaFilterChange = onHativaFilterChange;

function updateCommitteeTypeFilter() {
    const hativaFilter = document.getElementById('filterHativa').value;
    const committeeTypeSelect = document.getElementById('filterCommitteeType');
    const currentCommitteeType = committeeTypeSelect.value;
    let currentCommitteeTypeStillVisible = false;
    
    // Enable/disable based on hativa selection
    if (!hativaFilter) {
        committeeTypeSelect.disabled = true;
        committeeTypeSelect.value = '';
    } else {
        committeeTypeSelect.disabled = false;
    }
    
    // Show/hide committee type options based on hativa selection
    Array.from(committeeTypeSelect.options).forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        
        if (!hativaFilter || option.dataset.hativa === hativaFilter) {
            option.style.display = '';
            if (option.value === currentCommitteeType) {
                currentCommitteeTypeStillVisible = true;
            }
        } else {
            option.style.display = 'none';
        }
    });
    
    // If current committee type is not visible anymore, clear the selection
    if (currentCommitteeType && !currentCommitteeTypeStillVisible) {
        committeeTypeSelect.value = '';
    }
}

function filterTable() {
    const hativaFilter = document.getElementById('filterHativa').value;
    const maslulSelect = document.getElementById('filterMaslul');
    const maslulFilter = maslulSelect.disabled ? '' : maslulSelect.value; // Don't filter by maslul if disabled
    const committeeTypeFilter = document.getElementById('filterCommitteeType').value;
    const eventTypeFilter = document.getElementById('filterEventType').value;
    const dateFromFilter = document.getElementById('filterDateFrom').value;
    const dateToFilter = document.getElementById('filterDateTo').value;
    const textFilter = document.getElementById('filterText').value.toLowerCase().trim();
    const minRequestsFilter = document.getElementById('filterMinRequests').value;
    const maxRequestsFilter = document.getElementById('filterMaxRequests').value;
    
    // Check which view is active
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');
    
    if (committeesViewRadio && committeesViewRadio.checked) {
        filterCommitteeTable(hativaFilter, committeeTypeFilter, eventTypeFilter, dateFromFilter, dateToFilter, textFilter, minRequestsFilter, maxRequestsFilter);
        return;
    }
    
    const rows = document.querySelectorAll('#eventsTable tbody tr');
    let visibleCount = 0;
    let visibleRequests = 0;
    
    // Filter table rows
    rows.forEach(row => {
        let show = true;
        
        // Filter by hativa
        if (hativaFilter) {
            const rowHativaId = (row.dataset.hativaId || '').toString();
            if (rowHativaId !== hativaFilter) {
                show = false;
            }
        }
        
        // Filter by maslul (only if hativa is selected)
        if (maslulFilter && hativaFilter) {
            const rowMaslulId = (row.dataset.maslulId || '').toString();
            if (rowMaslulId !== maslulFilter) {
                show = false;
            }
        }
        
        // Filter by committee type
        if (committeeTypeFilter) {
            const rowCommitteeType = (row.dataset.committeeType || '').toString();
            if (rowCommitteeType !== committeeTypeFilter) {
                show = false;
            }
        }
        
        // Filter by event type
        if (eventTypeFilter) {
            const rowEventType = (row.dataset.eventType || '').toString();
            if (rowEventType !== eventTypeFilter) {
                show = false;
            }
        }
        
        // Filter by date range - only filter if date exists, don't hide rows without dates
        if (dateFromFilter || dateToFilter) {
            const eventDate = row.dataset.committeeDate;
            if (eventDate) {
                if (dateFromFilter && eventDate < dateFromFilter) {
                    show = false;
                }
                if (dateToFilter && eventDate > dateToFilter) {
                    show = false;
                }
            }
            // If no date and filters are set, we still show the row (don't hide rows without dates)
        }
        
        // Filter by text - search in multiple fields
        if (textFilter) {
            const searchFields = [
                row.dataset.eventName || '',
                row.dataset.hativaName || '',
                row.dataset.maslulName || '',
                row.dataset.committeeName || ''
            ];
            const found = searchFields.some(field => field.toLowerCase().includes(textFilter));
            if (!found) {
                show = false;
            }
        }
        
        // Filter by requests range
        if (minRequestsFilter || maxRequestsFilter) {
            const requests = parseInt(row.dataset.expectedRequests) || 0;
            if (minRequestsFilter) {
                const minRequests = parseInt(minRequestsFilter) || 0;
                if (requests < minRequests) {
                    show = false;
                }
            }
            if (maxRequestsFilter) {
                const maxRequests = parseInt(maxRequestsFilter) || 0;
                if (requests > maxRequests) {
                    show = false;
                }
            }
        }
        
        // Show/hide row
        row.style.display = show ? '' : 'none';
        
        if (show) {
            visibleCount++;
            visibleRequests += parseInt(row.dataset.expectedRequests) || 0;
        }
    });
    
    // Update stats
    document.getElementById('visibleEvents').textContent = visibleCount;
    document.getElementById('totalRequests').textContent = visibleRequests;
    document.getElementById('avgRequests').textContent = visibleCount > 0 ? (visibleRequests / visibleCount).toFixed(1) : '0';

    // Re-apply sorting after filtering
    applyCurrentSort();
}

function filterCommitteeTable(hativaFilter, committeeTypeFilter, eventTypeFilter, dateFromFilter, dateToFilter, textFilter, minRequestsFilter, maxRequestsFilter) {
    const rows = document.querySelectorAll('#committeeTableBody .committee-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let show = true;
        
        // Filter by hativa
        if (hativaFilter) {
            const rowHativaId = (row.dataset.hativaId || '').toString();
            if (rowHativaId !== hativaFilter) {
                show = false;
            }
        }
        
        // Filter by committee type
        if (committeeTypeFilter) {
            const rowCommitteeType = (row.dataset.committeeType || '').toString();
            if (rowCommitteeType !== committeeTypeFilter) {
                show = false;
            }
        }
        
        // Filter by event type - check if any event in the committee matches
        if (eventTypeFilter) {
            const eventTypesStr = row.dataset.eventTypes || '';
            if (eventTypesStr) {
                const eventTypes = eventTypesStr.split(',').filter(t => t.trim());
                if (!eventTypes.includes(eventTypeFilter)) {
                    show = false;
                }
            } else {
                // No event types means no events match
                show = false;
            }
        }
        
        // Filter by date range
        if (dateFromFilter || dateToFilter) {
            const committeeDate = row.dataset.committeeDate;
            if (committeeDate) {
                if (dateFromFilter && committeeDate < dateFromFilter) {
                    show = false;
                }
                if (dateToFilter && committeeDate > dateToFilter) {
                    show = false;
                }
            }
        }
        
        // Filter by text - search in committee name and hativa name
        if (textFilter) {
            const searchFields = [
                row.dataset.committeeName || '',
                row.dataset.hativaName || ''
            ];
            const found = searchFields.some(field => field.toLowerCase().includes(textFilter));
            if (!found) {
                show = false;
            }
        }
        
        // Filter by requests range
        if (minRequestsFilter || maxRequestsFilter) {
            const totalRequests = parseInt(row.dataset.totalRequests) || 0;
            if (minRequestsFilter) {
                const minRequests = parseInt(minRequestsFilter) || 0;
                if (totalRequests < minRequests) {
                    show = false;
                }
            }
            if (maxRequestsFilter) {
                const maxRequests = parseInt(maxRequestsFilter) || 0;
                if (totalRequests > maxRequests) {
                    show = false;
                }
            }
        }
        
        // Show/hide row and its events row
        row.style.display = show ? '' : 'none';
        const eventsRow = document.getElementById(`events-${row.dataset.committeeId}`);
        if (eventsRow) {
            // Keep events row hidden unless expanded, but hide it if committee row is hidden
            if (!show) {
                eventsRow.style.display = 'none';
            } else {
                // Keep current state (expanded/collapsed)
                const isExpanded = row.querySelector('.expand-button')?.dataset.expanded === 'true';
                eventsRow.style.display = isExpanded ? '' : 'none';
            }
        }
        
        if (show) {
            visibleCount++;
        }
    });
}

function updateMaslulFilter() {
    const hativaFilter = document.getElementById('filterHativa').value;
    const maslulSelect = document.getElementById('filterMaslul');
    const currentMaslul = maslulSelect.value;
    let currentMaslulStillVisible = false;
    
    // Enable/disable maslul filter based on hativa selection
    if (!hativaFilter) {
        // No hativa selected - disable filter and clear selection
        maslulSelect.disabled = true;
        maslulSelect.value = '';
        Array.from(maslulSelect.options).forEach(option => {
            option.style.display = '';
        });
    } else {
        // Hativa selected - enable filter and show only maslulim from that hativa
        maslulSelect.disabled = false;
        
        // Show/hide maslul options based on hativa selection
        Array.from(maslulSelect.options).forEach(option => {
            if (option.value === '') {
                option.style.display = '';
                return;
            }
            
            if (option.dataset.hativa === hativaFilter) {
                option.style.display = '';
                if (option.value === currentMaslul) {
                    currentMaslulStillVisible = true;
                }
            } else {
                option.style.display = 'none';
            }
        });
        
        // If current maslul is not visible anymore, clear the selection
        if (currentMaslul && !currentMaslulStillVisible) {
            maslulSelect.value = '';
        }
    }
}

function updateCommitteeTypeFilter() {
    const hativaFilter = document.getElementById('filterHativa').value;
    const committeeTypeSelect = document.getElementById('filterCommitteeType');
    const currentCommitteeType = committeeTypeSelect.value;
    let currentCommitteeTypeStillVisible = false;
    
    // Enable/disable based on hativa selection
    if (!hativaFilter) {
        committeeTypeSelect.disabled = true;
        committeeTypeSelect.value = '';
    } else {
        committeeTypeSelect.disabled = false;
    }
    
    // Show/hide committee type options based on hativa selection
    Array.from(committeeTypeSelect.options).forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        
        if (!hativaFilter || option.dataset.hativa === hativaFilter) {
            option.style.display = '';
            if (option.value === currentCommitteeType) {
                currentCommitteeTypeStillVisible = true;
            }
        } else {
            option.style.display = 'none';
        }
    });
    
    // If current committee type is not visible anymore, clear the selection
    if (currentCommitteeType && !currentCommitteeTypeStillVisible) {
        committeeTypeSelect.value = '';
    }
}

function clearAllFilters() {
    document.getElementById('filterHativa').value = '';
    document.getElementById('filterMaslul').value = '';
    document.getElementById('filterCommitteeType').value = '';
    document.getElementById('filterEventType').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterText').value = '';
    document.getElementById('filterMinRequests').value = '';
    document.getElementById('filterMaxRequests').value = '';
    
    // Update dependent filters
    updateMaslulFilter();
    updateCommitteeTypeFilter();
    filterTable();
}

function exportToCSV() {
    const table = document.getElementById('eventsTable');
    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
    
    let csv = 'חטיבה,מסלול,שם האירוע,סוג,בקשות צפויות,פרסום קול קורא,סיום קול קורא,סיום קליטה,סיום בדיקה,תאריך ועדה,תשובת ועדה,בקשות בפועל,נוצר\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const getCell = (i) => {
            let text = (cells[i]?.textContent || '').trim().replace(/\s+/g, ' ');
            if (text.includes(',') || text.includes('"')) {
                text = '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        };
        // Skip checkbox (0). Export columns 1..13 in the visual order
        const rowData = [
            getCell(1), // חטיבה
            getCell(2), // מסלול
            getCell(3), // שם האירוע
            getCell(4), // סוג
            getCell(5), // בקשות צפויות
            getCell(6), // פרסום קול קורא
            getCell(7), // סיום קול קורא
            getCell(8), // סיום קליטה
            getCell(9), // סיום בדיקה
            getCell(10), // תאריך ועדה
            getCell(11), // תשובת ועדה
            getCell(12), // הגשות בפועל
            getCell(13)  // נוצר
        ];
        csv += rowData.join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `events_table_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize filters on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize maslul filter state
    updateMaslulFilter();
    
    // Initialize committee type filter state
    updateCommitteeTypeFilter();
    
    filterTable();

    // Initialize view toggle
    initializeViewToggle();

    // Initialize bulk bar visibility
    onSelectionChanged();

    // Default sort by committee date ascending on load
    try { setSort('committeeDate', 'asc'); updateSortIndicators(); } catch (e) {}
});

// View Toggle Functions
function initializeViewToggle() {
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');
    const eventsTable = document.getElementById('eventsTable').closest('.table-responsive');
    const committeeView = document.getElementById('committeeView');

    eventsViewRadio.addEventListener('change', function() {
        if (this.checked) {
            eventsTable.style.display = 'block';
            committeeView.style.display = 'none';
            // Re-apply filters to table
            filterTable();
            document.getElementById('bulkDeleteEventsBtn').classList.remove('d-none');
            document.getElementById('bulkDeleteCommitteesBtn').classList.add('d-none');
        }
    });

    committeesViewRadio.addEventListener('change', function() {
        if (this.checked) {
            eventsTable.style.display = 'none';
            committeeView.style.display = 'block';
            // Load committee view
            loadCommitteeView();
            document.getElementById('bulkDeleteEventsBtn').classList.add('d-none');
            document.getElementById('bulkDeleteCommitteesBtn').classList.remove('d-none');
        }
    });
}

async function loadCommitteeView() {
    const container = document.getElementById('committeeTableBody');

    try {
        // Show loading state
        container.innerHTML = '<tr><td colspan="9" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">טוען...</span></div></td></tr>';

        // Fetch committee data from API - always include empty committees
        const response = await fetch('/api/events_by_committee?include_empty=1');
        const data = await response.json();

        if (data.success) {
            renderCommitteeTable(data.events_by_committee);
            // Apply filters after rendering
            filterTable();
        } else {
            container.innerHTML = `<tr><td colspan="9" class="text-center">
                <div class="no-committees">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>שגיאה בטעינת נתוני הועדות</h5>
                    <p>${data.error}</p>
                </div>
            </td></tr>`;
        }
    } catch (error) {
        container.innerHTML = `<tr><td colspan="9" class="text-center">
            <div class="no-committees">
                <i class="bi bi-exclamation-triangle"></i>
                <h5>שגיאה בחיבור לשרת</h5>
                <p>אנא נסה שוב מאוחר יותר</p>
            </div>
        </td></tr>`;
    }
}

function renderCommitteeTable(committees) {
    const tbody = document.getElementById('committeeTableBody');

    if (!committees || committees.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center">
            <div class="no-committees">
                <i class="bi bi-calendar-x"></i>
                <h5>אין ועדות עם אירועים</h5>
                <p>צור אירועים כדי לראות אותם מקובצים לפי ועדות</p>
            </div>
        </td></tr>`;
        return;
    }

    let html = '';
    committees.forEach(committee => {
        const eventTypes = committee.summary.event_types.length > 0 ?
            committee.summary.event_types.map(type => {
                if (type === 'kokok') return '<span class="badge badge-kokok">קו"ק</span>';
                if (type === 'shotef') return '<span class="badge badge-shotef">שוטף</span>';
                return `<span class="badge bg-secondary">${type}</span>`;
            }).join(' ') : '<span class="text-muted">אין סוגים</span>';

        // Get hativa_id and committee_type_id from committee info
        const hativaId = (committee.committee_info.hativa_id || '').toString();
        const committeeTypeId = (committee.committee_info.committee_type_id || '').toString();
        const vaadaDate = committee.committee_info.vaada_date || '';
        const committeeName = (committee.committee_info.committee_name || '').toLowerCase();
        const hativaName = (committee.committee_info.hativa_name || '').toLowerCase();
        
        html += `
            <tr class="committee-row" 
                data-committee-id="${committee.committee_info.vaadot_id}"
                data-hativa-id="${hativaId}"
                data-committee-type="${committeeTypeId}"
                data-committee-date="${vaadaDate}"
                data-committee-name="${committeeName}"
                data-hativa-name="${hativaName}"
                data-total-requests="${committee.summary.total_expected_requests || 0}"
                data-event-types="${committee.summary.event_types.join(',')}">
                <td>
                    <input type="checkbox" class="committee-select" value="${committee.committee_info.vaadot_id}" onchange="onSelectionChanged()">
                </td>
                <td>
                    <button class="expand-button" onclick="toggleCommitteeRow('${committee.committee_info.vaadot_id}')" data-expanded="false">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </td>
                <td>${committee.committee_info.committee_name}</td>
                <td>${committee.committee_info.hativa_name}</td>
                <td>${committee.committee_info.committee_type}</td>
                <td>${formatDate(committee.committee_info.vaada_date)}</td>
                <td><span class="badge bg-primary">${committee.summary.total_events}</span></td>
                <td><strong>${committee.summary.total_expected_requests}</strong></td>
                <td><strong>${committee.summary.total_actual_submissions}</strong></td>
                <td>${eventTypes}</td>
            </tr>
            <tr class="events-row" id="events-${committee.committee_info.vaadot_id}" style="display: none;">
                <td colspan="9">
                    <div class="events-container">
                        ${committee.events.map(event => `
                            <div class="event-item">
                                <div class="event-name">${event.name}</div>
                                <div class="event-details">
                                    <strong>מסלול:</strong> ${event.maslul_name} •
                                    <strong>בקשות צפויות:</strong> ${event.expected_requests} •
                                    <strong>בקשות בפועל:</strong> ${event.actual_submissions || 0}
                                    ${event.event_type ? `• <span class="badge ${event.event_type === 'kokok' ? 'badge-kokok' : 'badge-shotef'}">${event.event_type === 'kokok' ? 'קו"ק' : 'שוטף'}</span>` : ''}
                                </div>
                                <div class="event-details mt-2">
                                    <strong>תאריכים:</strong>
                                    ${event.call_deadline_date ? `סיום קול קורא: ${(event.is_call_deadline_manual == 1 || event.is_call_deadline_manual === true) ? '<i class="bi bi-pencil-square" style="font-size: 0.75rem; color: #721c24;" title="תאריך שונה ידנית"></i> ' : ''}${formatDate(event.call_deadline_date)} • ` : ''}
                                    ${event.intake_deadline_date ? `סיום קליטה: ${formatDate(event.intake_deadline_date)} • ` : ''}
                                    ${event.review_deadline_date ? `סיום בדיקה: ${formatDate(event.review_deadline_date)}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function toggleCommitteeRow(committeeId) {
    const button = document.querySelector(`[data-committee-id="${committeeId}"] .expand-button`);
    const eventsRow = document.getElementById(`events-${committeeId}`);
    const icon = button.querySelector('i');

    const isExpanded = button.dataset.expanded === 'true';

    if (isExpanded) {
        // Collapse
        eventsRow.style.display = 'none';
        button.dataset.expanded = 'false';
        icon.className = 'bi bi-chevron-right';
        button.closest('.committee-row').classList.remove('expanded');
    } else {
        // Expand
        eventsRow.style.display = 'table-row';
        button.dataset.expanded = 'true';
        icon.className = 'bi bi-chevron-down';
        button.closest('.committee-row').classList.add('expanded');
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'תאריך לא ידוע';

    try {
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    } catch (e) {
        return dateStr;
    }
}

// Update export function to handle committee view
function exportToCSV() {
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');

    if (committeesViewRadio.checked) {
        exportCommitteeViewToCSV();
    } else {
        // Original export logic for events table
        const table = document.getElementById('eventsTable');
        const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');

        let csv = 'חטיבה,מסלול,שם האירוע,סוג,בקשות צפויות,פרסום קול קורא,סיום קול קורא,סיום קליטה,סיום בדיקה,תאריך ועדה,תשובת ועדה,בקשות בפועל,נוצר\n';

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const getCell = (i) => {
                let text = (cells[i]?.textContent || '').trim().replace(/\s+/g, ' ');
                if (text.includes(',') || text.includes('"')) {
                    text = '"' + text.replace(/"/g, '""') + '"';
                }
                return text;
            };
            const rowData = [
                getCell(1), // חטיבה
                getCell(2), // מסלול
                getCell(3), // שם האירוע
                getCell(4), // סוג
                getCell(5), // בקשות צפויות
                getCell(6), // פרסום קול קורא
                getCell(7), // סיום קול קורא
                getCell(8), // סיום קליטה
                getCell(9), // סיום בדיקה
                getCell(10), // תאריך ועדה
                getCell(11), // תשובת ועדה
                getCell(12), // הגשות בפועל
                getCell(13)  // נוצר
            ];
            csv += rowData.join(',') + '\n';
        });

        downloadCSV(csv, `events_table_${new Date().toISOString().split('T')[0]}.csv`);
    }
}

async function exportCommitteeViewToCSV() {
    try {
        const response = await fetch('/api/events_by_committee');
        const data = await response.json();

        if (!data.success) {
            alert('שגיאה בטעינת נתוני הועדות לייצוא');
            return;
        }

        let csv = 'שם ועדה,חטיבה,סוג ועדה,תאריך ועדה,מספר אירועים,בקשות צפויות,בקשות בפועל,סוגי אירועים,פרטי אירועים\n';

        data.events_by_committee.forEach(committee => {
            const eventTypes = committee.summary.event_types.join('; ');
            const eventsDetails = committee.events.map(event =>
                `"${event.name} (${event.maslul_name}, ${event.expected_requests} בקשות${event.event_type ? ', ' + (event.event_type === 'kokok' ? 'קו"ק' : 'שוטף') : ''})"`
            ).join('; ');

            const rowData = [
                committee.committee_info.committee_name,
                committee.committee_info.hativa_name,
                committee.committee_info.committee_type,
                committee.committee_info.vaada_date || '',
                committee.summary.total_events,
                committee.summary.total_expected_requests,
                committee.summary.total_actual_submissions,
                eventTypes,
                eventsDetails
            ];

            csv += rowData.map(field => {
                const text = String(field || '');
                return text.includes(',') || text.includes('"') || text.includes('\n') ?
                    '"' + text.replace(/"/g, '""') + '"' : text;
            }).join(',') + '\n';
        });

        downloadCSV(csv, `committees_detailed_${new Date().toISOString().split('T')[0]}.csv`);
    } catch (error) {
        alert('שגיאה בייצוא נתוני הועדות');
    }
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Excel export functions
function exportToExcel() {
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');

    if (committeesViewRadio.checked) {
        exportCommitteeViewToExcel();
    } else {
        exportEventsViewToExcel();
    }
}

function exportToPDF() {
    const eventsViewRadio = document.getElementById('eventsView');
    const committeesViewRadio = document.getElementById('committeesView');

    if (committeesViewRadio.checked) {
        exportCommitteeViewToPDF();
    } else {
        exportEventsViewToPDF();
    }
}

if (!window.eventsTableUtils) {
    window.eventsTableUtils = {};
}

window.eventsTableUtils.getActiveFilters = function getActiveFilters() {
    const filters = [];
    
    const hativaFilter = document.getElementById('filterHativa');
    if (hativaFilter && hativaFilter.value) {
        const hativaName = hativaFilter.options[hativaFilter.selectedIndex].text;
        filters.push(`חטיבה: ${hativaName}`);
    }
    
    const maslulFilter = document.getElementById('filterMaslul');
    if (maslulFilter && maslulFilter.value) {
        const maslulName = maslulFilter.options[maslulFilter.selectedIndex].text;
        filters.push(`מסלול: ${maslulName}`);
    }
    
    const committeeTypeFilter = document.getElementById('filterCommitteeType');
    if (committeeTypeFilter && committeeTypeFilter.value) {
        const committeeTypeName = committeeTypeFilter.options[committeeTypeFilter.selectedIndex].text;
        filters.push(`סוג ועדה: ${committeeTypeName}`);
    }
    
    const eventTypeFilter = document.getElementById('filterEventType');
    if (eventTypeFilter && eventTypeFilter.value) {
        const eventTypeName = eventTypeFilter.options[eventTypeFilter.selectedIndex].text;
        filters.push(`סוג אירוע: ${eventTypeName}`);
    }
    
    const dateFromFilter = document.getElementById('filterDateFrom');
    const dateToFilter = document.getElementById('filterDateTo');
    if (dateFromFilter && dateFromFilter.value) {
        const dateFrom = new Date(dateFromFilter.value).toLocaleDateString('he-IL');
        if (dateToFilter && dateToFilter.value) {
            const dateTo = new Date(dateToFilter.value).toLocaleDateString('he-IL');
            filters.push(`תאריך: ${dateFrom} - ${dateTo}`);
        } else {
            filters.push(`תאריך מ-: ${dateFrom}`);
        }
    } else if (dateToFilter && dateToFilter.value) {
        const dateTo = new Date(dateToFilter.value).toLocaleDateString('he-IL');
        filters.push(`תאריך עד: ${dateTo}`);
    }
    
    const textFilter = document.getElementById('filterText');
    if (textFilter && textFilter.value.trim()) {
        filters.push(`חיפוש: ${textFilter.value.trim()}`);
    }
    
    const minRequestsFilter = document.getElementById('filterMinRequests');
    const maxRequestsFilter = document.getElementById('filterMaxRequests');
    if (minRequestsFilter && minRequestsFilter.value) {
        if (maxRequestsFilter && maxRequestsFilter.value) {
            filters.push(`בקשות: ${minRequestsFilter.value} - ${maxRequestsFilter.value}`);
        } else {
            filters.push(`בקשות מ-: ${minRequestsFilter.value}`);
        }
    } else if (maxRequestsFilter && maxRequestsFilter.value) {
        filters.push(`בקשות עד: ${maxRequestsFilter.value}`);
    }
    
    return filters;
};

function getActiveFilters() {
    return window.eventsTableUtils.getActiveFilters();
}

function exportEventsViewToPDF() {
    const table = document.getElementById('eventsTable');
    const headerCells = Array.from(table.querySelectorAll('thead th'))
        .slice(1) // skip checkbox
        .map(th => th.textContent.trim());
    const rows = Array.from(table.querySelectorAll('tbody tr'))
        .filter(row => row.style.display !== 'none')
        .map(row => Array.from(row.querySelectorAll('td')).slice(1).map(td => td.textContent.trim().replace(/\s+/g, ' ')));

    const win = window.open('', '_blank');
    if (!win) {
        alert('אנא אפשר חלונות קופצים כדי לייצא ל-PDF');
        return;
    }
    const today = new Date().toLocaleDateString('he-IL');
    const activeFilters = getActiveFilters();
    const filtersHtml = activeFilters.length > 0 ? `
    <div class="meta" style="margin-bottom: 8px;">
        <strong>פילטרים פעילים:</strong> ${activeFilters.join(' • ')}
    </div>` : '';
    
    const html = `
<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<title>ייצוא אירועים - ${today}</title>
<style>
    body { font-family: sans-serif; margin: 24px; }
    h1 { font-size: 18px; margin: 0 0 12px 0; }
    .meta { color: #555; font-size: 12px; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; direction: rtl; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; vertical-align: top; }
    th { background: #f8f9fa; }
    @media print {
        @page { size: A4 landscape; margin: 12mm; }
        body { margin: 0; }
    }
</style>
</head>
<body>
    <h1>טבלת אירועים</h1>
    <div class="meta">תאריך ייצוא: ${today}</div>
    ${filtersHtml}
    <table>
        <thead>
            <tr>${headerCells.map(h => `<th>${h}</th>`).join('')}</tr>
        </thead>
        <tbody>
            ${rows.map(cols => `<tr>${cols.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}
        </tbody>
    </table>
    <scr` + `ipt>window.addEventListener('load', () => { window.print(); setTimeout(() => window.close(), 300); });</scr` + `ipt>
</body>
</html>`;
    win.document.open();
    win.document.write(html);
    win.document.close();
}

function exportCommitteeViewToPDF() {
    const table = document.getElementById('committeeTable');
    const headerCells = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    const rows = Array.from(document.querySelectorAll('#committeeTableBody tr.committee-row'))
        .filter(row => row.style.display !== 'none')
        .map(row => {
            const tds = Array.from(row.querySelectorAll('td'));
            // skip checkbox and expand button columns (first two)
            const textCols = tds.slice(2).map(td => td.textContent.trim().replace(/\s+/g, ' '));
            return textCols;
        });

    const win = window.open('', '_blank');
    if (!win) {
        alert('אנא אפשר חלונות קופצים כדי לייצא ל-PDF');
        return;
    }
    const today = new Date().toLocaleDateString('he-IL');
    const activeFilters = getActiveFilters();
    const filtersHtml = activeFilters.length > 0 ? `
    <div class="meta" style="margin-bottom: 8px;">
        <strong>פילטרים פעילים:</strong> ${activeFilters.join(' • ')}
    </div>` : '';
    
    const html = `
<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<title>ייצוא ועדות - ${today}</title>
<style>
    body { font-family: sans-serif; margin: 24px; }
    h1 { font-size: 18px; margin: 0 0 12px 0; }
    .meta { color: #555; font-size: 12px; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; direction: rtl; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; vertical-align: top; }
    th { background: #f8f9fa; }
    @media print {
        @page { size: A4 landscape; margin: 12mm; }
        body { margin: 0; }
    }
</style>
</head>
<body>
    <h1>טבלת ועדות</h1>
    <div class="meta">תאריך ייצוא: ${today}</div>
    ${filtersHtml}
    <table>
        <thead>
            <tr>${headerCells.slice(2).map(h => `<th>${h}</th>`).join('')}</tr>
        </thead>
        <tbody>
            ${rows.map(cols => `<tr>${cols.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}
        </tbody>
    </table>
    <scr` + `ipt>window.addEventListener('load', () => { window.print(); setTimeout(() => window.close(), 300); });</scr` + `ipt>
</body>
</html>`;
    win.document.open();
    win.document.write(html);
    win.document.close();
}
function exportEventsViewToExcel() {
    const table = document.getElementById('eventsTable');
    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');

    // Create worksheet data
    const wsData = [];
    
    // Add metadata rows with filters
    const activeFilters = getActiveFilters();
    if (activeFilters.length > 0) {
        wsData.push(['פילטרים פעילים:']);
        activeFilters.forEach(filter => {
            wsData.push([filter]);
        });
        wsData.push([]); // Empty row
    }
    
    // Add headers
    wsData.push([
        'חטיבה',
        'מסלול',
        'שם האירוע',
        'סוג',
        'בקשות צפויות',
        'פרסום קול קורא',
        'סיום קול קורא',
        'סיום קליטה',
        'סיום בדיקה',
        'תאריך ועדה',
        'תשובת ועדה',
        'בקשות בפועל',
        'נוצר'
    ]);

    // Add data rows
    const parseDate = (str, isDateTime = false) => {
        if (!str) return '';
        try {
            const norm = isDateTime ? str.replace(' ', 'T') : str;
            const d = new Date(norm);
            if (isNaN(d.getTime())) return '';
            return d;
        } catch (_) {
            return '';
        }
    };
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const txt = (i) => (cells[i]?.textContent || '').trim().replace(/\s+/g, ' ');
        const num = (v) => {
            const n = parseFloat(v);
            return Number.isFinite(n) ? n : 0;
        };
        const rowData = [
            txt(1),                                       // חטיבה
            txt(2),                                       // מסלול
            txt(3),                                       // שם האירוע
            txt(4),                                       // סוג
            num(row.dataset.expectedRequests),            // בקשות צפויות (number)
            parseDate(row.dataset.callPublication),       // פרסום קול קורא (date)
            parseDate(row.dataset.callDeadline),          // סיום קול קורא (date)
            parseDate(row.dataset.intakeDeadline),        // סיום קליטה (date)
            parseDate(row.dataset.reviewDeadline),        // סיום בדיקה (date)
            parseDate(row.dataset.committeeDate),         // תאריך ועדה (date)
            parseDate(row.dataset.responseDeadline),      // תשובת ועדה (date)
            num(row.dataset.actualSubmissions),           // הגשות בפועל (number)
            parseDate(row.dataset.createdAt, true)        // נוצר (datetime)
        ];
        wsData.push(rowData);
    });

    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Set column widths
    ws['!cols'] = [
        { wch: 15 }, // חטיבה
        { wch: 20 }, // מסלול
        { wch: 25 }, // שם האירוע
        { wch: 10 }, // סוג
        { wch: 12 }, // בקשות צפויות
        { wch: 15 }, // פרסום קול קורא
        { wch: 15 }, // סיום קול קורא
        { wch: 15 }, // סיום קליטה
        { wch: 15 }, // סיום בדיקה
        { wch: 12 }, // תאריך ועדה
        { wch: 15 }, // תשובת ועדה
        { wch: 12 }, // הגשות בפועל
        { wch: 18 }  // נוצר
    ];

    // Apply formats for date and number columns using previously captured filters
    const filterRowsCount = activeFilters.length > 0 ? activeFilters.length + 2 : 0; // +1 for "פילטרים פעילים:" row, +1 for empty row
    const dataStartRow = filterRowsCount + 1; // +1 for header row
    
    const dateCols = [6, 7, 8, 9, 10, 11, 13]; // indices of date-like columns (1-based)
    const numCols = [5, 12]; // indices of numeric columns (1-based)
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = dataStartRow; R <= range.e.r; R++) { // skip header and filter rows
        dateCols.forEach(C1 => {
            const C = C1 - 1;
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = ws[cellRef];
            if (cell && cell.v && Object.prototype.toString.call(cell.v) === '[object Date]') {
                cell.t = 'd';
                cell.z = 'dd/mm/yyyy';
            }
        });
        numCols.forEach(C1 => {
            const C = C1 - 1;
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = ws[cellRef];
            if (cell && typeof cell.v === 'number') {
                cell.t = 'n';
                cell.z = '0';
            }
        });
    }

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'אירועים');

    // Generate and download Excel file
    const filename = `events_table_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
}

async function exportCommitteeViewToExcel() {
    try {
        const response = await fetch('/api/events_by_committee');
        const data = await response.json();

        if (!data.success) {
            alert('שגיאה בטעינת נתוני הועדות לייצוא');
            return;
        }

        // Create worksheet data
        const wsData = [];
        
        // Add metadata rows with filters
        const activeFilters = getActiveFilters();
        if (activeFilters.length > 0) {
            wsData.push(['פילטרים פעילים:']);
            activeFilters.forEach(filter => {
                wsData.push([filter]);
            });
            wsData.push([]); // Empty row
        }
        
        // Add headers
        wsData.push([
            'שם ועדה',
            'חטיבה',
            'סוג ועדה',
            'תאריך ועדה',
            'מספר אירועים',
            'בקשות צפויות',
            'בקשות בפועל',
            'סוגי אירועים',
            'פרטי אירועים'
        ]);

        // Add data rows
        data.events_by_committee.forEach(committee => {
            const eventTypes = committee.summary.event_types.join('; ');
            const eventsDetails = committee.events.map(event =>
                `${event.name} (${event.maslul_name}, ${event.expected_requests} בקשות${event.event_type ? ', ' + (event.event_type === 'kokok' ? 'קו"ק' : 'שוטף') : ''})`
            ).join('; ');

            wsData.push([
                committee.committee_info.committee_name,
                committee.committee_info.hativa_name,
                committee.committee_info.committee_type,
                committee.committee_info.vaada_date || '',
                committee.summary.total_events,
                committee.summary.total_expected_requests,
                committee.summary.total_actual_submissions,
                eventTypes,
                eventsDetails
            ]);
        });

        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Set column widths
        ws['!cols'] = [
            { wch: 20 }, // שם ועדה
            { wch: 15 }, // חטיבה
            { wch: 20 }, // סוג ועדה
            { wch: 12 }, // תאריך ועדה
            { wch: 12 }, // מספר אירועים
            { wch: 12 }, // בקשות צפויות
            { wch: 12 }, // בקשות בפועל
            { wch: 20 }, // סוגי אירועים
            { wch: 50 }  // פרטי אירועים
        ];

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'ועדות');

        // Generate and download Excel file
        const filename = `committees_detailed_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('שגיאה בייצוא נתוני הועדות ל-Excel');
    }
}

// Bulk selection / actions
function getSelectedEventIds() {
    return Array.from(document.querySelectorAll('.event-select:checked'))
        .map(cb => parseInt(cb.value))
        .filter(Number.isFinite);
}

function getSelectedCommitteeIds() {
    return Array.from(document.querySelectorAll('.committee-select:checked'))
        .map(cb => parseInt(cb.value))
        .filter(Number.isFinite);
}

function onSelectionChanged() {
    const eventsSelected = getSelectedEventIds().length;
    const committeesSelected = getSelectedCommitteeIds().length;
    const total = eventsSelected + committeesSelected;
    const bar = document.getElementById('bulkActionBar');
    const selectedCount = document.getElementById('selectedCount');
    if (total > 0) {
        bar.classList.remove('d-none');
        selectedCount.textContent = total;
    } else {
        bar.classList.add('d-none');
        selectedCount.textContent = '0';
    }
}

function toggleSelectAllEvents(master) {
    const visibleRows = Array.from(document.querySelectorAll('#eventsTable tbody tr'))
        .filter(row => row.style.display !== 'none');
    visibleRows.forEach(row => {
        const cb = row.querySelector('.event-select');
        if (cb) cb.checked = master.checked;
    });
    onSelectionChanged();
}

function toggleSelectAllCommittees(master) {
    const visibleRows = Array.from(document.querySelectorAll('#committeeTableBody .committee-row'));
    visibleRows.forEach(row => {
        const cb = row.querySelector('.committee-select');
        if (cb) cb.checked = master.checked;
    });
    onSelectionChanged();
}

function clearSelections() {
    document.querySelectorAll('.event-select, .committee-select').forEach(cb => cb.checked = false);
    const selectAllEvents = document.getElementById('selectAllEvents');
    const selectAllCommittees = document.getElementById('selectAllCommittees');
    if (selectAllEvents) selectAllEvents.checked = false;
    if (selectAllCommittees) selectAllCommittees.checked = false;
    onSelectionChanged();
}

async function confirmBulkDeleteEvents() {
    const ids = getSelectedEventIds();
    if (ids.length === 0) return;
    if (!confirm(`האם למחוק ${ids.length} אירועים שנבחרו?`)) return;
    await bulkDeleteEvents(ids);
}

async function confirmBulkDeleteCommittees() {
    const ids = getSelectedCommitteeIds();
    if (ids.length === 0) return;
    if (!confirm(`האם למחוק ${ids.length} ועדות שנבחרו (כולל כל האירועים שלהן)?`)) return;
    await bulkDeleteCommittees(ids);
}

async function bulkDeleteEvents(eventIds) {
    try {
        const res = await fetch('/api/events/bulk_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event_ids: eventIds })
        });
        const data = await res.json();
        if (data.success) {
            // Remove deleted rows from table
            eventIds.forEach(id => {
                const row = document.querySelector(`#eventsTable tbody tr[data-event-id="${id}"]`);
                if (row) row.remove();
            });
            clearSelections();
            filterTable();
            alert(`נמחקו ${data.deleted_count} אירועים`);
        } else {
            alert(data.message || 'שגיאה במחיקה מרובה');
        }
    } catch (e) {
        alert('שגיאה בביצוע הבקשה');
    }
}

async function bulkDeleteCommittees(vaadotIds) {
    try {
        const res = await fetch('/api/committees/bulk_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vaadot_ids: vaadotIds })
        });
        const data = await res.json();
        if (data.success) {
            // Refresh committee view
            loadCommitteeView();
            clearSelections();
            alert(`נמחקו ${data.deleted_committees} ועדות ו-${data.deleted_events} אירועים`);
        } else {
            alert(data.message || 'שגיאה במחיקה מרובה');
        }
    } catch (e) {
        alert('שגיאה בביצוע הבקשה');
    }
}
</script>
{% endblock %}
