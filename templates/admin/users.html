{% extends "base.html" %}

{% block title %}ניהול משתמשים{% endblock %}

{% block extra_head %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-card .card-body {
        padding: 1.5rem;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .user-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .user-card:hover {
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .role-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    
    .role-admin {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
    }
    
    .role-editor {
        background: linear-gradient(45deg, #4834d4, #686de0);
        color: white;
    }
    
    .role-viewer {
        background: linear-gradient(45deg, #00d2d3, #54a0ff);
        color: white;
    }
    
    .hativot-badge {
        font-size: 0.75rem;
        margin: 2px;
        display: inline-block;
    }
    
    .status-active {
        color: #28a745;
    }
    
    .status-inactive {
        color: #dc3545;
    }
    
    .action-btn {
        margin: 0 2px;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .search-box {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 10px;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header text-center">
        <h1 class="mb-0">
            <i class="fas fa-users me-3"></i>
            ניהול משתמשים
        </h1>
        <p class="mb-0 mt-2">ניהול מלא של משתמשי המערכת והרשאותיהם</p>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-number">{{ stats.total_users }}</div>
                    <div class="stats-label">סה"כ משתמשים</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-number">{{ stats.active_users }}</div>
                    <div class="stats-label">משתמשים פעילים</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-number">{{ stats.admin_count }}</div>
                    <div class="stats-label">מנהלי מערכת</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-number">{{ stats.editor_count }}</div>
                    <div class="stats-label">עורכים</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-number">{{ stats.viewer_count }}</div>
                    <div class="stats-label">צופים</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-number">{{ stats.inactive_users }}</div>
                    <div class="stats-label">משתמשים לא פעילים</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control search-box" placeholder="🔍 חפש משתמש לפי שם, אימייל או שם משתמש...">
        </div>
        <div class="col-md-3">
            <select id="roleFilter" class="form-select">
                <option value="">כל התפקידים</option>
                <option value="admin">מנהל מערכת</option>
                <option value="editor">עורך</option>
                <option value="viewer">צופה</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus me-2"></i>הוסף משתמש חדש
            </button>
        </div>
    </div>

    <!-- Users List -->
    <div class="row" id="usersList">
        {% for user in users %}
        <div class="col-md-6 col-lg-4 user-item" 
             data-username="{{ user.username }}" 
             data-email="{{ user.email }}" 
             data-fullname="{{ user.full_name }}" 
             data-role="{{ user.role }}">
            <div class="card user-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="card-title mb-1">{{ user.full_name }}</h5>
                            <p class="text-muted mb-1">{{ user.username }}</p>
                            <p class="text-muted mb-0">{{ user.email }}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge role-{{ user.role }} role-badge">
                                {% if user.role == 'admin' %}
                                    👑 מנהל מערכת
                                {% elif user.role == 'editor' %}
                                    ✏️ עורך
                                {% else %}
                                    👁️ צופה
                                {% endif %}
                            </span>
                            <br>
                            {% if user.auth_source == 'ad' %}
                                <span class="badge bg-info mt-2">
                                    <i class="fas fa-server"></i> Active Directory
                                </span>
                            {% else %}
                                <span class="badge bg-secondary mt-2">
                                    <i class="fas fa-database"></i> מקומי
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">חטיבות:</small><br>
                            {% if user.hativot %}
                                {% for hativa in user.hativot %}
                                    <span class="badge bg-primary hativot-badge">{{ hativa.name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">ללא הגבלה (גישה לכל החטיבות)</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">סטטוס:</small><br>
                            <span class="fw-bold {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                                {% if user.is_active %}
                                    ✅ פעיל
                                {% else %}
                                    ❌ לא פעיל
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">התחברות אחרונה:</small><br>
                            <span class="fw-bold">
                                {% if user.last_login %}
                                    {{ user.last_login }}
                                {% else %}
                                    מעולם לא התחבר
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                            <button class="btn btn-outline-primary action-btn edit-user-btn" 
                                    data-user-id="{{ user.user_id }}"
                                    data-username="{{ user.username }}"
                                    data-email="{{ user.email }}"
                                    data-fullname="{{ user.full_name }}"
                                    data-role="{{ user.role }}"
                                    data-hativa-ids="{% if user.hativot %}{{ user.hativot|map(attribute='hativa_id')|list|tojson }}{% else %}[]{% endif %}">
                                <i class="fas fa-edit"></i> ערוך
                            </button>
                            {% if user.auth_source != 'ad' %}
                            <button class="btn btn-outline-info action-btn change-password-btn" 
                                    data-user-id="{{ user.user_id }}"
                                    data-fullname="{{ user.full_name }}">
                                <i class="fas fa-key"></i> סיסמה
                            </button>
                            {% else %}
                            <button class="btn btn-outline-secondary action-btn" disabled 
                                    title="משתמשי AD מנוהלים דרך Active Directory">
                                <i class="fas fa-key"></i> סיסמה AD
                            </button>
                            {% endif %}
                        </div>
                        <div>
                            {% if user.user_id != current_user.user_id %}
                            <form method="POST" action="{{ url_for('toggle_user_status', user_id=user.user_id) }}" class="d-inline">
                                <button type="submit" class="btn btn-outline-warning action-btn" 
                                        onclick="return confirm('האם אתה בטוח שברצונך לשנות את סטטוס המשתמש?')">
                                    {% if user.is_active %}
                                        <i class="fas fa-pause"></i> השבת
                                    {% else %}
                                        <i class="fas fa-play"></i> הפעל
                                    {% endif %}
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('delete_user', user_id=user.user_id) }}" class="d-inline">
                                <button type="submit" class="btn btn-outline-danger action-btn" 
                                        onclick="return confirm('האם אתה בטוח שברצונך למחוק את המשתמש? פעולה זו אינה הפיכה.')">
                                    <i class="fas fa-trash"></i> מחק
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>הוסף משתמש חדש
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_user') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">שם משתמש *</label>
                            <input type="text" name="username" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">אימייל *</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">שם מלא *</label>
                        <input type="text" name="full_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">סיסמה *</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">תפקיד *</label>
                        <select name="role" class="form-select" id="addUserRole">
                            <option value="viewer">צופה - הרשאות קריאה בלבד</option>
                            <option value="editor">עורך - קריאה ועריכה</option>
                            <option value="admin">מנהל מערכת - גישה מלאה לכל</option>
                        </select>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            <span id="addRoleHelp">צופה: גישה לדף הבית, טבלת אירועים ומדריך</span>
                        </small>
                    </div>
                    <div class="mb-3" id="addHativotSection">
                        <label class="form-label">חטיבות נגישות</label>
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for hativa in hativot %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="hativa_ids[]" 
                                       value="{{ hativa.hativa_id }}" id="addHativa{{ hativa.hativa_id }}">
                                <label class="form-check-label" for="addHativa{{ hativa.hativa_id }}">
                                    {{ hativa.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            אם לא תבחר חטיבה, המשתמש יוכל לגשת לכל החטיבות
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>צור משתמש
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>ערוך משתמש
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_user') }}">
                <input type="hidden" name="user_id" id="editUserId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">שם משתמש *</label>
                            <input type="text" name="username" id="editUsername" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">אימייל *</label>
                            <input type="email" name="email" id="editEmail" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">שם מלא *</label>
                        <input type="text" name="full_name" id="editFullName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">תפקיד *</label>
                        <select name="role" id="editRole" class="form-select">
                            <option value="viewer">צופה - הרשאות קריאה בלבד</option>
                            <option value="editor">עורך - קריאה ועריכה</option>
                            <option value="admin">מנהל מערכת - גישה מלאה לכל</option>
                        </select>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            <span id="editRoleHelp">בחר את רמת ההרשאות</span>
                        </small>
                    </div>
                    <div class="mb-3" id="editHativotSection">
                        <label class="form-label">חטיבות נגישות</label>
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for hativa in hativot %}
                            <div class="form-check">
                                <input class="form-check-input edit-hativa-checkbox" type="checkbox" name="hativa_ids[]" 
                                       value="{{ hativa.hativa_id }}" id="editHativa{{ hativa.hativa_id }}">
                                <label class="form-check-label" for="editHativa{{ hativa.hativa_id }}">
                                    {{ hativa.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            אם לא תבחר חטיבה, המשתמש יוכל לגשת לכל החטיבות
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>שמור שינויים
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>שינוי סיסמה
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('change_user_password') }}">
                <input type="hidden" name="user_id" id="changePasswordUserId">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        שינוי סיסמה עבור: <strong id="changePasswordUserName"></strong>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">סיסמה חדשה *</label>
                        <input type="password" name="new_password" class="form-control" required minlength="6">
                        <div class="form-text">הסיסמה חייבת להכיל לפחות 6 תווים</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">אימות סיסמה *</label>
                        <input type="password" id="confirmPassword" class="form-control" required minlength="6">
                        <div class="form-text">הקלד את הסיסמה שוב לאימות</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>שנה סיסמה
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    filterUsers(searchTerm, roleFilter);
});

// Role filter
document.getElementById('roleFilter').addEventListener('change', function() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const roleFilter = this.value;
    filterUsers(searchTerm, roleFilter);
});

function filterUsers(searchTerm, roleFilter) {
    const userItems = document.querySelectorAll('.user-item');
    
    userItems.forEach(function(item) {
        const username = item.getAttribute('data-username').toLowerCase();
        const email = item.getAttribute('data-email').toLowerCase();
        const fullname = item.getAttribute('data-fullname').toLowerCase();
        const role = item.getAttribute('data-role');
        
        const matchesSearch = username.includes(searchTerm) || 
                            email.includes(searchTerm) || 
                            fullname.includes(searchTerm);
        
        const matchesRole = !roleFilter || role === roleFilter;
        
        if (matchesSearch && matchesRole) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Edit user event listeners
document.addEventListener('DOMContentLoaded', function() {
    const editButtons = document.querySelectorAll('.edit-user-btn');
    editButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            const email = this.getAttribute('data-email');
            const fullName = this.getAttribute('data-fullname');
            const role = this.getAttribute('data-role');
            const hativaIdsStr = this.getAttribute('data-hativa-ids');
            const hativaIds = JSON.parse(hativaIdsStr || '[]');
            
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editFullName').value = fullName;
            document.getElementById('editRole').value = role;
            
            // Clear all checkboxes first
            document.querySelectorAll('.edit-hativa-checkbox').forEach(cb => cb.checked = false);
            
            // Check the appropriate hativot
            hativaIds.forEach(hativaId => {
                const checkbox = document.getElementById('editHativa' + hativaId);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            editModal.show();
        });
    });
    
    // Change password event listeners
    const changePasswordButtons = document.querySelectorAll('.change-password-btn');
    changePasswordButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const fullName = this.getAttribute('data-fullname');
            
            document.getElementById('changePasswordUserId').value = userId;
            document.getElementById('changePasswordUserName').textContent = fullName;
            
            const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            changePasswordModal.show();
        });
    });
});

// Password confirmation validation
document.getElementById('changePasswordModal').addEventListener('submit', function(e) {
    const newPassword = this.querySelector('input[name="new_password"]').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('הסיסמאות אינן תואמות');
        return false;
    }
});

// Form validation
document.querySelectorAll('form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(function(field) {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('אנא מלא את כל השדות הנדרשים');
        }
    });
});
</script>
{% endblock %}
