# תכונת סל מחזור - תיעוד

## סקירה כללית

תכונת סל המחזור מאפשרת שחזור של ועדות ואירועים שנמחקו בטעות. במקום מחיקה קשה (hard delete), המערכת מבצעת מחיקה רכה (soft delete) שמסמנת פריטים כמחוקים אך שומרת אותם במסד הנתונים.

## שינויים במסד הנתונים

### עמודות חדשות

נוספו העמודות הבאות לטבלאות `vaadot` ו-`events`:

- **`is_deleted`** (INTEGER DEFAULT 0): מציין אם הפריט נמחק (0 = פעיל, 1 = נמחק)
- **`deleted_at`** (TIMESTAMP): תאריך ושעת המחיקה
- **`deleted_by`** (INTEGER): מזהה המשתמש שביצע את המחיקה

### מיגרציה אוטומטית

העמודות נוספות אוטומטית למסד נתונים קיים באמצעות מנגנון המיגרציה ב-`database.py`.

## פונקציות חדשות ב-`database.py`

### פונקציות מחיקה רכה (עודכנו):

- **`delete_vaada(vaadot_id, user_id)`**: מחיקה רכה של ועדה
- **`delete_event(event_id, user_id)`**: מחיקה רכה של אירוע
- **`delete_vaadot_bulk(vaadot_ids, user_id)`**: מחיקה רכה מרובה של ועדות
- **`delete_events_bulk(event_ids, user_id)`**: מחיקה רכה מרובה של אירועים

### פונקציות שאילתה (עודכנו):

- **`get_vaadot(include_deleted=False)`**: החזרת ועדות (ללא נמחקים כברירת מחדל)
- **`get_events(include_deleted=False)`**: החזרת אירועים (ללא נמחקים כברירת מחדל)
- **`get_all_events(include_deleted=False)`**: החזרת כל האירועים עם מידע מורחב

### פונקציות סל מחזור (חדשות):

#### שליפת פריטים נמחקים:
- **`get_deleted_vaadot(hativa_id=None)`**: קבלת כל הועדות שנמחקו
- **`get_deleted_events(hativa_id=None)`**: קבלת כל האירועים שנמחקו

#### שחזור פריטים:
- **`restore_vaada(vaadot_id)`**: שחזור ועדה מהסל
- **`restore_event(event_id)`**: שחזור אירוע מהסל

#### מחיקה קשה:
- **`permanently_delete_vaada(vaadot_id)`**: מחיקה קשה של ועדה (רק מסל המחזור)
- **`permanently_delete_event(event_id)`**: מחיקה קשה של אירוע (רק מסל המחזור)
- **`empty_recycle_bin(hativa_id=None)`**: ריקון סל המחזור (מחיקה קשה של כל הפריטים)

## API Endpoints חדשים ב-`app.py`

### נתיבים עיקריים:

#### `GET /recycle_bin`
- תצוגת סל המחזור
- גישה: מנהלים ומנהלי מערכת בלבד
- מציג ועדות ואירועים שנמחקו

#### `POST /api/recycle_bin/restore_vaada/<vaadot_id>`
- שחזור ועדה מהסל
- גישה: מנהלים ומנהלי מערכת
- מנהלים יכולים לשחזר רק מהחטיבה שלהם

#### `POST /api/recycle_bin/restore_event/<event_id>`
- שחזור אירוע מהסל
- גישה: מנהלים ומנהלי מערכת
- מנהלים יכולים לשחזר רק מהחטיבה שלהם

#### `POST /api/recycle_bin/permanent_delete_vaada/<vaadot_id>`
- מחיקה לצמיתות של ועדה
- גישה: מנהלי מערכת בלבד
- מחיקה בלתי הפיכה

#### `POST /api/recycle_bin/permanent_delete_event/<event_id>`
- מחיקה לצמיתות של אירוע
- גישה: מנהלי מערכת בלבד
- מחיקה בלתי הפיכה

#### `POST /api/recycle_bin/empty`
- ריקון סל המחזור
- גישה: מנהלי מערכת בלבד
- מוחק לצמיתות את כל הפריטים בסל

## ממשק משתמש

### קובץ: `templates/recycle_bin.html`

דף סל המחזור כולל:

#### כרטיסי סטטיסטיקה:
- מספר ועדות שנמחקו
- מספר אירועים שנמחקו
- כפתור לריקון הסל (מנהלי מערכת בלבד)

#### טבלת ועדות שנמחקו:
- תאריך ועדה
- שם ועדה
- חטיבה
- מי מחק
- מתי נמחק
- כפתורי פעולה: שחזור (מנהלים+), מחיקה קשה (מנהלי מערכת)

#### טבלת אירועים שנמחקו:
- שם אירוע
- סוג (קו קו / שותף)
- מסלול
- תאריך ועדה
- ועדה
- מי מחק
- מתי נמחק
- כפתורי פעולה: שחזור (מנהלים+), מחיקה קשה (מנהלי מערכת)

### קובץ: `templates/base.html`

נוסף קישור לסל המחזור בתפריט הניווט:
- גלוי רק למנהלים ומנהלי מערכת
- ממוקם בין "טבלת אירועים" ל"מדריך למשתמש"

## הרשאות וביטחון

### משתמשים רגילים (role='user'):
- **לא יכולים** למחוק פריטים (כמו קודם)
- **לא יכולים** לגשת לסל המחזור
- **לא יכולים** לשחזר פריטים

### מנהלי חטיבה (role='manager'):
- **יכולים** למחוק פריטים (מחיקה רכה) בחטיבה שלהם בלבד
- **יכולים** לגשת לסל המחזור (רואים רק פריטים מהחטיבה שלהם)
- **יכולים** לשחזר פריטים מהחטיבה שלהם בלבד
- **לא יכולים** למחוק לצמיתות

### מנהלי מערכת (role='admin'):
- **יכולים** למחוק פריטים מכל החטיבות (מחיקה רכה)
- **יכולים** לגשת לסל המחזור (רואים את כל הפריטים)
- **יכולים** לשחזר כל פריט
- **יכולים** למחוק לצמיתות פריטים בודדים
- **יכולים** לרוקן את כל סל המחזור

## תכונות מיוחדות

### שחזור אוטומטי של אירועים קשורים:
כאשר מוחקים ועדה:
- כל האירועים הקשורים לועדה מסומנים גם כן כמחוקים
- כאשר משחזרים ועדה, כל האירועים הקשורים משוחזרים אוטומטית

### מעקב אחר מי מחק:
- המערכת שומרת מי ביצע את המחיקה
- מוצג בטבלת סל המחזור
- נרשם ב-audit logs

### מניעת זיהום נתונים:
- פריטים שנמחקו לא מוצגים ברשימות רגילות
- שאילתות מסננות אוטומטית פריטים נמחקים
- ניתן לכלול פריטים נמחקים במפורש על ידי `include_deleted=True`

## רישום ביקורת (Audit Logging)

כל פעולה על סל המחזור נרשמת:

### פעולות מחיקה:
- מחיקה רכה של ועדה/אירוע
- מחיקה מרובה

### פעולות שחזור:
- שחזור ועדה/אירוע מהסל
- ACTION_TYPE: CREATE (כי זה מחזיר את הפריט למערכת)

### פעולות מחיקה קשה:
- מחיקה לצמיתות של פריט בודד
- ריקון סל מחזור
- ACTION_TYPE: DELETE עם פירוט המספרים

## הודעות משתמש משופרות

הודעות המחיקה עודכנו:
- **לפני**: "אירוע נמחק בהצלחה"
- **אחרי**: "אירוע הועבר לסל המחזור בהצלחה"

זה מבהיר למשתמש שהפריט לא נמחק לצמיתות.

## דוגמאות שימוש

### שחזור ועדה באמצעות JavaScript:
```javascript
fetch(`/api/recycle_bin/restore_vaada/${vaadotId}`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    }
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        alert(data.message);
        location.reload();
    }
});
```

### שחזור ועדה באמצעות Python:
```python
# Get deleted committees
deleted_vaadot = db.get_deleted_vaadot(hativa_id=1)

# Restore specific committee
success = db.restore_vaada(vaadot_id=5)

# Permanently delete
success = db.permanently_delete_vaada(vaadot_id=5)
```

## תאימות לאחור

השינויים תואמים לאחור:
- העמודות החדשות נוספות אוטומטית למסד נתונים קיים
- פריטים קיימים מקבלים `is_deleted=0` (או NULL) באופן אוטומטי
- פונקציות קיימות ממשיכות לעבוד עם ברירת המחדל של החרגת פריטים נמחקים

## בדיקות והתקנה

### בדיקה ידנית מומלצת:

1. **מחיקת ועדה**:
   - מחק ועדה עם אירועים
   - וודא שהועדה והאירועים מופיעים בסל המחזור
   - וודא שהם לא מופיעים בתצוגות רגילות

2. **שחזור ועדה**:
   - שחזר ועדה מהסל
   - וודא שהועדה והאירועים חוזרים לתצוגות רגילות
   - וודא שהם נעלמים מסל המחזור

3. **מחיקת אירוע**:
   - מחק אירוע בודד
   - וודא שהוא מופיע בסל המחזור
   - שחזר אותו

4. **הרשאות**:
   - התחבר כמשתמש רגיל - וודא שאין גישה לסל
   - התחבר כמנהל חטיבה - וודא שרואה רק את הפריטים מהחטיבה שלו
   - התחבר כמנהל מערכת - וודא שרואה את כל הפריטים

5. **מחיקה קשה**:
   - כמנהל מערכת, מחק פריט לצמיתות
   - וודא שהוא נעלם לגמרי מהמערכת

6. **ריקון סל**:
   - כמנהל מערכת, רוקן את הסל
   - וודא שכל הפריטים נמחקו לצמיתות

## קבצים שהשתנו

### קבצי Backend:
- ✅ `database.py` - פונקציות מחיקה, שאילתה וסל מחזור
- ✅ `app.py` - API endpoints ונתיבים חדשים

### קבצי Frontend:
- ✅ `templates/recycle_bin.html` - דף סל המחזור (חדש)
- ✅ `templates/base.html` - קישור בתפריט הניווט

### קבצי תיעוד:
- ✅ `RECYCLE_BIN_FEATURE.md` - מסמך זה

## סיכום

תכונת סל המחזור מספקת:
- 🛡️ הגנה מפני מחיקות בטעות
- 🔄 שחזור קל של ועדות ואירועים
- 🔒 שמירה על הרשאות והיררכיית חטיבות
- 📝 מעקב מלא ביומני ביקורת
- 👥 ניהול נפרד למנהלים ומנהלי מערכת

התכונה משולבת בצורה חלקה במערכת הקיימת ולא דורשת שינויים בזרימות העבודה הנוכחיות.

