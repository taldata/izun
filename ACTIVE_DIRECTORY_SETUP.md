# הגדרת Active Directory במערכת ניהול ועדות

## סקירה כללית

המערכת תומכת כעת באימות משתמשים דרך Active Directory (AD) בנוסף למשתמשים מקומיים. זה מאפשר:

- **אימות מרכזי**: משתמשים מתחברים עם פרטי ה-AD שלהם
- **סנכרון אוטומטי**: מידע משתמשים מתעדכן אוטומטית מ-AD
- **ניהול הרשאות**: מיפוי קבוצות AD לתפקידים במערכת
- **Fallback מקומי**: משתמשים מקומיים (כמו admin) ממשיכים לפעול

## דרישות מקדימות

### 1. התקנת ספריות נדרשות

הוסף לסביבה שלך:

```bash
pip install bcrypt>=4.0.0 ldap3>=2.9.1
```

או הרץ:

```bash
pip install -r requirements.txt
```

### 2. חשבון שירות ב-Active Directory

צור חשבון שירות ב-AD עם ההרשאות הבאות:
- **Read** על כל ה-Users OU
- **Read** על כל ה-Groups OU
- אין צורך בהרשאות Write

**דוגמה**:
- Username: `svc_committee_app`
- Password: `SecureP@ssw0rd!`
- DN: `CN=svc_committee_app,CN=Users,DC=company,DC=local`

### 3. גישת רשת

ודא שהשרת יכול להתחבר לשרת ה-AD על הפורטים:
- **LDAPS (מומלץ)**: פורט 636
- **LDAP**: פורט 389

## הגדרת Active Directory

### שלב 1: כניסה לממשק הגדרות AD

1. התחבר כמשתמש **admin**
2. לחץ על תפריט המשתמש בפינה השמאלית
3. בחר **"הגדרות Active Directory"**

### שלב 2: הגדרות חיבור

#### כתובת שרת AD
```
ad.company.local
או
192.168.1.10
```

#### פורט
- **636** - ל-LDAPS (מומלץ - מאובטח)
- **389** - ל-LDAP (לא מומלץ - לא מוצפן)

#### אפשרויות אבטחה
- ✅ **השתמש ב-SSL/LDAPS** - מומלץ מאוד
- ☐ **השתמש ב-STARTTLS** - רק אם SSL לא זמין

### שלב 3: הגדרות ספרייה

#### Base DN
הנתיב הבסיסי לכל החיפושים:
```
DC=company,DC=local
```

#### חשבון שירות (Bind DN)
```
CN=svc_committee_app,CN=Users,DC=company,DC=local
```

#### סיסמת חשבון שירות
```
SecureP@ssw0rd!
```

#### בסיס חיפוש משתמשים (אופציונלי)
אם המשתמשים נמצאים ב-OU ספציפי:
```
OU=Employees,DC=company,DC=local
```

אם ריק - יחפש בכל ה-Base DN.

#### פילטר חיפוש משתמשים
```
(sAMAccountName={username})
```

הפילטר `{username}` יוחלף בשם המשתמש בזמן האימות.

### שלב 4: מיפוי תפקידים

#### קבוצת מנהלי מערכת
משתמשים בקבוצה זו יקבלו הרשאות **admin**:
```
CN=Committee System Admins,CN=Groups,DC=company,DC=local
```

או פשוט שם הקבוצה:
```
Committee System Admins
```

#### קבוצת מנהלי חטיבות
משתמשים בקבוצה זו יקבלו הרשאות **manager**:
```
CN=Division Managers,CN=Groups,DC=company,DC=local
```

#### משתמשים ללא קבוצה
משתמשי AD שאינם בקבוצות מוגדרות יקבלו הרשאות **user** רגיל.

### שלב 5: הגדרות סנכרון

#### ✅ צור משתמשים אוטומטית בהתחברות ראשונה
משתמש AD שמצליח להתחבר ייווצר אוטומטית במערכת המקומית.

#### ✅ סנכרן פרטי משתמש מ-AD בכל התחברות
שם מלא ואימייל יתעדכנו מ-AD בכל כניסה.

#### חטיבת ברירת מחדל למשתמשים חדשים
בחר חטיבה שתוקצה למשתמשי AD חדשים באופן אוטומטי.

### שלב 6: בדיקת חיבור

לחץ על כפתור **"בדוק חיבור"** כדי לוודא שההגדרות תקינות.

הודעות אפשריות:
- ✅ **"החיבור ל-Active Directory הצליח"** - כל ההגדרות תקינות
- ❌ **"פרטי התחברות לשרת AD שגויים"** - בדוק את חשבון השירות
- ❌ **"שגיאה בהתחברות לשרת AD"** - בדוק כתובת ופורט
- ❌ **"שגיאת חיבור"** - בדוק חיבור רשת וfirewall

### שלב 7: שמירה והפעלה

1. סמן ✅ **"הפעל אימות Active Directory"**
2. לחץ **"שמור הגדרות"**

## דוגמאות הגדרה

### דוגמה 1: חברה קטנה

```
שרת: ad.company.local
פורט: 636
SSL: ✅ כן
Base DN: DC=company,DC=local
Bind DN: CN=ADReader,CN=Users,DC=company,DC=local
User Search Base: CN=Users,DC=company,DC=local
Admin Group: Domain Admins
```

### דוגמה 2: ארגון עם OUs מורכבות

```
שרת: dc1.organization.gov.il
פורט: 636
SSL: ✅ כן
Base DN: DC=organization,DC=gov,DC=il
Bind DN: CN=ServiceAccount,OU=ServiceAccounts,DC=organization,DC=gov,DC=il
User Search Base: OU=Staff,OU=People,DC=organization,DC=gov,DC=il
User Search Filter: (sAMAccountName={username})
Admin Group: CN=IT-Admins,OU=IT,OU=Groups,DC=organization,DC=gov,DC=il
Manager Group: CN=Department-Heads,OU=Management,OU=Groups,DC=organization,DC=gov,DC=il
```

## שימוש במערכת

### התחברות משתמש AD

1. משתמש מזין שם משתמש וסיסמה מה-AD
2. המערכת מנסה אימות דרך AD
3. אם מצליח:
   - משתמש חדש נוצר אוטומטית (אם מופעל)
   - תפקיד נקבע לפי קבוצות AD
   - המשתמש מועבר לדף הבית
4. אם נכשל - מופיעה הודעת שגיאה

### ניהול משתמשי AD

בדף **"ניהול משתמשים"** תראה:

- 🔵 **תג AD** - משתמשים שמקורם מ-Active Directory
- ⚫ **תג מקומי** - משתמשים מקומיים

משתמשי AD:
- ✅ ניתן לשנות תפקיד וחטיבה
- ✅ ניתן להשבית/להפעיל
- ❌ לא ניתן לשנות סיסמה (מנוהלת ב-AD)

משתמשים מקומיים:
- ✅ ניהול מלא כולל שינוי סיסמה

### משתמש Admin מקומי

המשתמש **admin** המקומי ממשיך לפעול תמיד:
- Username: `admin`
- Password: `admin123` (שנה מיד!)

זה מאפשר גישה גם אם AD לא זמין.

## פתרון בעיות

### בעיה: "משתמש לא נמצא ב-Active Directory"

**פתרון**:
1. ודא ש-`User Search Base` נכון
2. ודא ש-`User Search Filter` נכון
3. בדוק שהמשתמש קיים ב-AD וב-OU הנכון

### בעיה: "שם משתמש או סיסמה שגויים"

**סיבות אפשריות**:
1. סיסמה שגויה
2. חשבון משתמש נעול ב-AD
3. חשבון משתמש לא פעיל ב-AD
4. פג תוקף הסיסמה ב-AD

### בעיה: "שגיאה בהתחברות לשרת AD"

**פתרון**:
1. בדוק חיבור רשת: `ping ad.company.local`
2. בדוק פורט: `telnet ad.company.local 636`
3. בדוק firewall
4. בדוק אישור SSL (ל-LDAPS)

### בעיה: "פרטי התחברות לשרת AD שגויים"

**פתרון**:
1. ודא שפרטי חשבון השירות נכונים
2. בדוק שחשבון השירות פעיל
3. בדוק שלחשבון יש הרשאות קריאה

### בעיה: משתמש AD לא מקבל הרשאות נכונות

**פתרון**:
1. בדוק שהמשתמש חבר בקבוצות הנכונות ב-AD
2. ודא שה-DN של הקבוצות נכון בהגדרות
3. סנכרן שוב את המשתמש
4. התנתק והתחבר מחדש

## אבטחה

### שמירת סיסמאות

- **משתמשים מקומיים**: סיסמאות מוצפנות ב-bcrypt (מומלץ)
- **משתמשי AD**: אין סיסמאות במסד נתונים מקומי
- **חשבון שירות**: סיסמה מאוחסנת מוצפנת במסד הנתונים

### המלצות אבטחה

1. ✅ השתמש תמיד ב-LDAPS (SSL)
2. ✅ שנה סיסמת admin ברירת המחדל
3. ✅ הגבל גישת חשבון השירות רק לקריאה
4. ✅ השתמש בסיסמה חזקה לחשבון השירות
5. ✅ רשום את כל פעולות המשתמשים (audit log)

## שאלות נפוצות

### האם ניתן להשתמש גם ב-AD וגם במשתמשים מקומיים?

כן! המערכת תומכת בשני סוגי המשתמשים במקביל.

### מה קורה אם שרת AD לא זמין?

משתמשים מקומיים (כמו admin) עדיין יכולים להתחבר.

### האם ניתן לשנות סיסמה למשתמש AD?

לא. סיסמאות משתמשי AD מנוהלות רק ב-Active Directory.

### האם המערכת תומכת ב-Multi-Forest?

כרגע המערכת תומכת ב-forest אחד. לתמיכה במספר forests יש ליצור חשבון שירות נפרד לכל forest.

### האם אפשר לייבא משתמשים מ-AD בצורה מרובה?

כרגע ייבוא משתמשים נעשה אוטומטית בהתחברות ראשונה. תכונת ייבוא מרובה תתווסף בגרסה עתידית.

## תמיכה טכנית

לבעיות או שאלות:
1. בדוק את יומן הביקורת (Audit Log)
2. בדוק את הלוגים של האפליקציה
3. פנה למנהל המערכת

---

**גרסה**: 1.0  
**עדכון אחרון**: אוקטובר 2025  
**תאימות**: Python 3.7+, Flask 3.0+, ldap3 2.9+

